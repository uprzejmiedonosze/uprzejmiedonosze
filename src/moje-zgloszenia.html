<? 
require_once(__DIR__ . '/../inc/include.php');

checkIfLogged();

$user = $storage->getCurrentUser();
$appIds = $user->getApplicationIds();

$changeMail = isset($_GET['changeMail']);
$changeEpuap = (!$changeMail) && isset($_GET['changeEpuap']);

$countChanged = 0;

$applications = [];

foreach($appIds as $id){
    $application = $storage->getApplication($id);
    array_push($applications, $application);
    if($changeMail || $changeEpuap){
        if($application->status == 'confirmed'){
            if($changeMail){
                $application->setStatus('confirmed-waiting');
            }
            if($changeEpuap){
                $application->setStatus('confirmed-waitingE');
            }
            $storage->saveApplication($application);
            $countChanged++;
        }
    }
}

if($changeMail || $changeEpuap){
    $storage->getUserStats(false); // update cache
}

generate('moje-zgloszenia.html.twig', 
    [
        'head' =>
        [
            'title' => "Moje zgłoszenia",
            'shortTitle' => "Moje zgłoszenia"
        ],
        'config' =>
        [
            'auth' => true,
            'appActionButtons' => true,
            'menu' => 'moje-zgloszenia'
        ],
        'applications' => $applications,
        'countChanged' => $countChanged
    ]
);
?>
