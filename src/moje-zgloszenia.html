<? 
require_once(__DIR__ . '/../inc/include.php');

checkIfLogged();

$user = $storage->getCurrentUser();
$appIds = $user->getApplicationIds();

$changeMail = isset($_GET['changeMail']) && isset($_GET['city']);
$city = isset($_GET['city'])? urldecode($_GET['city']): '';

$countChanged = 0;

$applications = [];

foreach($appIds as $id){
    $application = $storage->getApplication($id);
    array_push($applications, $application);
    if($changeMail){
        if($application->status == 'confirmed'){
            if($changeMail && $application->smCity == $city){
                $application->setStatus('confirmed-waiting');
                $countChanged++;
            }
            $storage->saveApplication($application);
        }
    }
}

if($changeMail){
    $storage->getUserStats(false); // updates the cache
}

echo generate('moje-zgloszenia.html.twig', 
    [
        'head' =>
        [
            'title' => "Moje zgłoszenia",
            'shortTitle' => "Moje zgłoszenia",
            'mainClass' => 'my-applications'
        ],
        'config' =>
        [
            'auth' => true,
            'appActionButtons' => true,
            'menu' => 'moje-zgloszenia'
        ],
        'applications' => $applications,
        'countChanged' => $countChanged,
        'applicationsCount' => count($applications),
        'applicationsLimit' => 200
    ]
);
?>
