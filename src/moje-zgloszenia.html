<? 
require_once(__DIR__ . '/../inc/include.php');

checkIfLogged();

$user = $storage->getCurrentUser();
$appIds = $user->getApplicationIds();

$changeMail = isset($_GET['changeMail']) && isset($_GET['city']);
$city = urldecode($_GET['city']);

$countChanged = 0;

$applications = [];

foreach($appIds as $id){
    $application = $storage->getApplication($id);
    array_push($applications, $application);
    if($changeMail || $changeEpuap){
        if($application->status == 'confirmed'){
            if($changeMail && $application->smCity == $city){
                $application->setStatus('confirmed-waiting');
                $countChanged++;
            }
            $storage->saveApplication($application);
        }
    }
}

if($changeMail || $changeEpuap){
    $storage->getUserStats(false); // updates the cache
}

echo generate('moje-zgloszenia.html.twig', 
    [
        'head' =>
        [
            'title' => "Moje zgłoszenia",
            'shortTitle' => "Moje zgłoszenia"
        ],
        'config' =>
        [
            'auth' => true,
            'appActionButtons' => true,
            'menu' => 'moje-zgloszenia'
        ],
        'applications' => $applications,
        'countChanged' => $countChanged
    ]
);
?>
