<? 
require_once(__DIR__ . '/../inc/include.php');

checkIfLogged();
$user = $storage->getCurrentUser();

if(!isset($_GET['city'])){
    $city = $storage->getNextCityToSent();
    logger("nextcity = $city");
    if($city){
        redirect("wysylka.html?city=" . urlencode($city));    
    }
    redirect("moje-zgloszenia.html");
}

$city = urldecode($_GET['city']);

$apps = $storage->getConfirmedAppsByCity($city);

if(count($apps) == 0){
    redirect("moje-zgloszenia.html");
}

$sm = reset($apps)->guessSMData();

echo generate('wysylka.html.twig', 
    [
        'head' =>
        [
            'title' => "Paczka dokumentów do SM",
            'shortTitle' => "Paczka dokumentów do SM"
        ],
        'config' =>
        [
            'auth' => true,
            'menu' => 'wysylka',
            'appActionButtons' => false,
            'wysylka' => true,
            'isIOS' => isIOS()
        ],
        'apps' => $apps,
        'user' => $user,
        'city' => $city,
        'sm' => $sm
    ]
);
?>
