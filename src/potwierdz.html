<? 
require_once(__DIR__ . '/../inc/include.php');
require(__DIR__ . '/../inc/API.php');

$post = $_POST;

if(!isset($post['applicationId'])){
    redirect("nowe-zgloszenie.html");
}

$appId = $post["applicationId"];

$date = $post['datetime'];
$dtFromPicture = $post['dtFromPicture'];
$category = $post["category"];
$fullAddress = new stdClass();
$fullAddress->address = $post["lokalizacja"];
$fullAddress->city = $post["city"];
$fullAddress->voivodeship = $post["voivodeship"];
$fullAddress->latlng = $post["latlng"];
$fullAddress->district = $post["district"];
$plateId = $post["plateId"];
$comment = $post["comment"];
$witness = isset($post['witness']);
@$extensions = $post["extensions"];

try {
    $application = updateApplication($appId, $date, $dtFromPicture, $category, $fullAddress,
        $plateId, $comment, $witness, $extensions);
} catch (Exception $e) {
    redirect("nowe-zgloszenie.html");
}

echo generate('potwierdz.html.twig', 
    [
        'head' =>
        [
            'title' => "Potwierdź",
            'shortTitle' => "Potwierdź",
            'mainClass' => 'confirm-application',
        ],
        'config' =>
        [
            'auth' => true,
            'isAppOwnerOrAdmin' => true,
            'confirmationScreen' => true
        ],
        'app' => $application,
        'autoSend' => $storage->getCurrentUser()->autoSend() && $application->automatedSM()
    ]
);

?>
