<? 
require_once(__DIR__ . '/../inc/include.php');

$post = $_POST;

if(!isset($post['applicationId'])){
    redirect("nowe-zgloszenie.html");
}

$applicationId = $post["applicationId"];
$application = $storage->getApplication($applicationId);

if(!$application->isEditable()){
    redirect("nowe-zgloszenie.html");
}

$user = $storage->getCurrentUser();

$application->date = date_format(new DateTime( preg_replace('/[^T0-9: -]/', '', $post['datetime']) ), DT_FORMAT);
$application->dtFromPicture = (boolean) $post['dtFromPicture'];
$application->category = intval($post["category"]);
if(!isset($application->address)) $application->address = new stdClass();
$application->address->address = $post["lokalizacja"];
$application->address->city = $post["city"];
$application->address->voivodeship = $post["voivodeship"];
$application->address->latlng = $post["latlng"];
$application->address->district = $post["district"];
$application->guessSMData(true); // stores sm city inside the object
if(!isset($application->carInfo)) $application->carInfo = new stdClass();
$application->carInfo->plateId = strtoupper(trim($post["plateId"]));
$application->userComment = capitalizeSentence($post["comment"]);
$application->initStatements();
$application->statements->witness = isset($post['witness']);
$application->setStatus("ready");

$storage->saveApplication($application);

echo generate('potwierdz.html.twig', 
    [
        'head' =>
        [
            'title' => "Potwierdź",
            'shortTitle' => "Potwierdź",
            'mainClass' => 'confirm-application',
        ],
        'config' =>
        [
            'auth' => true,
            'isAppOwnerOrAdmin' => true,
            'confirmationScreen' => true
        ],
        'app' => $application,
        'autoSend' => $user->autoSend() && $application->automatedSM()
    ]
);

?>
