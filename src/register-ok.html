<? 
require_once(__DIR__ . '/../inc/include.php');

checkIfLogged();

$signInSuccessUrl = 'start.html';
if(isset($_GET['next'])){
    $signInSuccessUrl = $_GET['next'];
}

$post = $_POST;
if (!isset($post["name"]) || !isset($post["address"])) {
    redirect('/register.html');
}

$name = capitalizeName($post["name"]);
$msisdn = trim($post["msisdn"]);
$exposeData = isset($post['exposeData']) && $post['exposeData'] == 'Y';
$stopAgresji = isset($post['stopAgresji']) && $post['stopAgresji'] == 'SA';
$autoSend = isset($post['autoSend']) && isset($post['autoSend']) ? $post['autoSend'] == 'Y' : true;
$myAppsSize = isset($post['myAppsSize']) ? intval($post['myAppsSize']) : 200;

$address = str_replace(', Polska', '', cleanWhiteChars($post["address"]));

try{
    $user = $storage->getCurrentUser();
}catch(Exception $e){ // creation mode
    $user = new User();
}

$user->updateUserData($name, $msisdn, $address, $exposeData, $stopAgresji, $autoSend, $myAppsSize);
$storage->saveUser($user);

if(!isset($_GET['update'])) _sendSlackOnRegister($user);

redirect($signInSuccessUrl);

?>
