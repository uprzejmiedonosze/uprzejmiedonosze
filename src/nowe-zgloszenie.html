<?PHP
require_once(__DIR__ . '/../inc/include.php');

checkIfRegistered();

if(isset($_GET['cleanup'])){
    unset($_SESSION['newAppId']);
    redirect("nowe-zgloszenie.html");
}

$user = $storage->getCurrentUser();

if(isset($_GET['TermsConfirmation'])){
    $user->confirmTerms();
    $storage->saveUser($user);    
}

if(!$user->checkTermsConfirmation()){
    redirect("start.html");
}

if(isset($_GET['edit'])){
    $application = $storage->getApplication($_GET['edit']);
    if(! $application->isEditable()) {
        throw new Exception("Nie mogę pozwolić na edycję zgłoszenia w statusie " . $application->getStatus()->name);
    }

    if(! ($application->isAppOwner() || isAdmin() )){
        throw new Exception("Próba edycji cudzego zgłoszenia. Nieładnie!");
    }

    $_SESSION['newAppId'] = $application->id;
    $edit = true;
}elseif(isset($_SESSION['newAppId'])){ // edit mode
    try{
        $application = $storage->getApplication($_SESSION['newAppId']);
        $edit = isset($application->carImage) || isset($application->contextImage);
        if (!$edit) {
            unset($application);
        } elseif (!$application->isEditable()) {
            unset($application);
        }
        $application->updateUserData($user);
    }catch(Exception $e){
        unset($application);
    }
}

if(!isset($application)){ // new application mode
    $application = Application::withUser($user);
    $storage->saveApplication($application);
    $_SESSION['newAppId'] = $application->id;
    $edit = false;
}


$dt = (new DateTime($application->date))->format(DT_FORMAT_SHORT);

$now = new DateTime();
$dtMax = $now->format(DT_FORMAT_SHORT);
$dtMin = $now->modify("-1 year")->format(DT_FORMAT_SHORT);

// edit app older than 1y
if ($dtMin > $dt) $dtMin = $dt;

echo generate('nowe-zgloszenie.html.twig', 
    [
        'head' =>
        [
            'title' => "Nowe zgłoszenie",
            'shortTitle' => "Nowe zgłoszenie",
            'mainClass' => 'new-application'
        ],
        'config' =>
        [
            'auth' => true,
            'edit' => $edit,
            'lastLocation' => $user->getLastLocation()
        ],
        'categoriesMatrix' => CATEGORIES_MATRIX,
        'app' => $application,
        'dtMin' => $dtMin,
        'dt' => $edit ? $dt : '',
        'dtMax' => $dtMax     
    ]
);

?>
