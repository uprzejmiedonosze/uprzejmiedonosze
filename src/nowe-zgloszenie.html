<?PHP
require_once(__DIR__ . '/../inc/include.php');

checkIfRegistered();

if(isset($_GET['cleanup'])){
    unset($_SESSION['newAppId']);
    redirect("nowe-zgloszenie.html");
}

$user = $storage->getCurrentUser();

if(isset($_GET['TermsConfirmation'])){
    $user->confirmTerms();
    $storage->saveUser($user);    
}

if($user->data->termsConfirmation < LATEST_TERMS_UPDATE){
    redirect("start.html");
}

if(isset($_GET['edit'])){
    $application = $storage->getApplication($_GET['edit']);
    if(! $application->isEditable()) {
        throw new Exception("Nie mogę pozwolić na edycję zgłoszenia w statusie " . $application->getStatus()->name);
    }

    if(! ($application->isAppOwner() || isAdmin() )){
        throw new Exception("Próba edycji cudzego zgłoszenia. Nieładnie!");
    }

    $_SESSION['newAppId'] = $application->id;
    $edit = true;
}elseif(isset($_SESSION['newAppId'])){ // edit mode
    try{
        $application = $storage->getApplication($_SESSION['newAppId']);
        $edit = isset($application->carImage) || isset($application->contextImage);
    }catch(Exception $e){
        unset($application);
    }
}

if(!isset($application)){ // new application mode
    $application = new Application();
    $storage->saveApplication($application);
    $_SESSION['newAppId'] = $application->id;
    $edit = false;
}

echo generate('nowe-zgloszenie.html.twig', 
    [
        'head' =>
        [
            'title' => "Nowe zgłoszenie",
            'shortTitle' => "Nowe zgłoszenie",
            'mainClass' => 'new-application'
        ],
        'config' =>
        [
            'auth' => true,
            'edit' => $edit,
            'lastLocation' => $user->getLastLocation()
        ],
        'categories' => $CATEGORIES,
        'categoriesMatrix' => CATEGORIES_MATRIX,
        'app' => $application
    ]
);

?>
