<?PHP
require_once(__DIR__ . '/../inc/include.php');

checkIfRegistered();

if(isset($_GET['cleanup'])){
    unset($_SESSION['newAppId']);
    redirect("nowe-zgloszenie.html");
}

if($storage->getCurrentUser()->isAdmin() && isset($_GET['edit'])){
    $application = $storage->getApplication($_GET['edit']);
    $_SESSION['newAppId'] = $application->id;
    $edit = true;
}elseif(isset($_SESSION['newAppId'])){ // edit mode
    try{
        $application = $storage->getApplication($_SESSION['newAppId']);
        $edit = isset($application->carImage) || isset($application->contextImage);
    }catch(Exception $e){
        unset($application);
    }
}

if(!isset($application)){ // new application mode
    $application = new Application();
    $storage->saveApplication($application);
    $_SESSION['newAppId'] = $application->id;
    $edit = false;
}

echo generate('nowe-zgloszenie.html.twig', 
    [
        'head' =>
        [
            'title' => "Nowe zgłoszenie",
            'shortTitle' => "Nowe zgłoszenie",
            'mainClass' => 'new-application',
            'mapsInitFunc' => 'initAutocompleteOnNewApplication'
        ],
        'config' =>
        [
            'auth' => true,
            'edit' => $edit,
            'lastLocation' => $storage->getCurrentUser()->getLastLocation()
        ],
        'categories' => $CATEGORIES,
        'categoriesMatrix' => CATEGORIES_MATRIX,
        'app' => $application
    ]
);

?>
