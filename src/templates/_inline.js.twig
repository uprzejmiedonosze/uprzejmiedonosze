/**
 * Updates application counters in menu.
 */
function updateCounters(){
    $('.filter a').each(function(idx, item){
        const count = $('div.application.status-' + item.id).length;
        item.children[0].innerText = count;
        if(count == 0){
            $(item).hide();
        }else{
            $(item).show();
        }
    });

    $('li.wysylka a span').text($('div.application.status-confirmed').length);
}

/**
 * Sets application status.
 * 
 * @param appId application id to change
 * @param status new status for the app
 */
function setStatus(appId, status){
    $.post('/api/api.html', {action: status, id: appId}).done(function() {
        _updateStatus(appId, status);
    });
    ga('send', 'event', { eventCategory: 'js', eventAction: 'setStatus', eventLabel: status});
}

/**
 * Send the application through API
 * 
 * @param appId application id to be sent
 */
function _send(appId){
    $("#send-" + appId).addClass('ui-disabled');
    $.mobile.loading( "show", { text: 'Wysyłam...', textVisible: true } );

    $.post("/api/api.html", { id: appId, action: "send" }, function(msg){
        _updateStatus(appId, msg.status);
        $.mobile.loading( "hide" );
        showMessage('Wysłane', 1000);
        ga('send', 'event', { eventCategory: 'js', eventAction: 'sendViaAPI'});
    }).fail(function (e){
        $("#send-" + appId).removeClass('ui-disabled');
        $.mobile.loading( "hide" );
        showMessage('Nie udało się wysłać zgłoszenia! ' + e.responseJSON.message, 4000);
        ga('send', 'event', { eventCategory: 'js-error', eventAction: 'sendViaAPI'});
    });
}

/**
 * Allow application to be placed in the gallery.
 * 
 * @param appId application id to be added to gallery
 */
function addToGallery(appId){
    $.post('/api/api.html', {action: 'addToGallery', id: appId}).done(function() {
        $('div.addToGallery').hide();
        $('#' + appId + ' .addToGallery').hide();
        $('.addedToGallery').show();
        ga('send', 'event', { eventCategory: 'js', eventAction: 'addToGallery'});
    });
}

function ignoreGallery(){
    $('div.addToGallery').hide();
    ga('send', 'event', { eventCategory: 'js', eventAction: 'ignoreGallery'});
}

/**
 * 
 * @param msg Message to display
 * @param timeout Time for the message to be visible in ms
 */
function showMessage(msg, timeout){
    $.mobile.loading( "show",
        { text: msg, textVisible: true, textonly: true } );
    window.setTimeout(function(){
        $.mobile.loading( "hide" );
    }, timeout);
}

function _updateStatus(appId, status){
    {% set allClasses = '' %}
    
    {% for key,val in statuses %}
        {% set allClasses = allClasses ~ ' status-' ~ key %}
    {% endfor %}

    $('#' + appId + ' .appActionButtons a').removeClass('ui-disabled').hide();
    $('#' + appId + ' .appActionButtons a.status-' + status).addClass('ui-disabled').show();
    statuses[status].allowed.forEach(function(allowed){
        $('#' + appId + ' .appActionButtons a.status-' + allowed).show();
    });

    $('#' + appId).removeClass('{{ allClasses }}');
    $('#' + appId).addClass('status-' + status);

    $('#' + appId + ' b.currentStatus').text($('#' + appId + ' .appActionButtons a.status-' + status).text());

    updateCounters();
}

const statuses = {{ include('statuses.json') }};