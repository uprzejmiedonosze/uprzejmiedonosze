{% set leftButton = 'menu' %}

{% extends "base.html.twig" %}

{% block main %}
<h3 id="login-hint">{% if config.logout %}logout{% endif %}</h3>
<div class="ui-body ui-body-a ui-corner-all">
    <div id="firebaseui-auth-container"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/ui/4.0.0/firebase-ui-auth__pl.js"></script>
<link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/4.0.0/firebase-ui-auth.css" />
<script type="text/javascript">
{% if config.logout %}
    logout();
{% else %}
    $( document ).bind( "pagecontainerload", function( e, triggerData ) {
        $('#login-hint').text('x-redir...');
        var redirect = triggerData.xhr.getResponseHeader( "X-Redirect" );
        if ( redirect ) {
            $( e.target ).pagecontainer( "load", redirect, triggerData.options );
            e.preventDefault();
        }
    });

    $(document).on("pageshow", function () {
        firebase.auth().signOut();
        firebase.auth().onAuthStateChanged(function(user) {
            if (user) {
                window.location.replace('/login-ok.html{% if config.signInSuccessUrl %}?next={{ config.signInSuccessUrl }}{% endif %}');
            } else {
                login();
            }
        }, function(error) {
            login();
        });
    });
{% endif %}

    function login(){
        $('#login-hint').text('Zaloguj się za pomocą konta Google lub Facebook.');
        var uiConfig = {
            signInSuccessUrl: "%HTTPS%://%HOST%/login-ok.html{% if config.signInSuccessUrl %}?next={{ config.signInSuccessUrl }}{% endif %}",
            signInOptions: [
                firebase.auth.GoogleAuthProvider.PROVIDER_ID,
                firebase.auth.FacebookAuthProvider.PROVIDER_ID
                ],
            tosUrl: '%HTTPS%://%HOST%/polityka-prywatnosci.html',
            privacyPolicyUrl: function() {
                window.location.assign('%HTTPS%://%HOST%/polityka-prywatnosci.html');
        }
        };
        var ui = new firebaseui.auth.AuthUI(firebase.auth());
        ui.start('#firebaseui-auth-container', uiConfig);

    }
    function logout(){
        firebase.auth().signOut();
        window.location.replace('/');
    }
</script>
{% endblock %}