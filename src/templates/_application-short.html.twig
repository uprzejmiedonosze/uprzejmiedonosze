{% set recydywa = app.getRecydywa %}
{% set status = app.getStatus %}
{% set sendable = status.sendable %}

{% macro icon(name) %}
    <span class="ui-btn ui-corner-all ui-icon-{{name}} ui-btn-icon-notext ui-btn-inline ui-btn-fake"></span>
{% endmacro %}

<div id="{{ app.id }}"
    {% if hideAppOverLimit is defined %}style="display: none;"{% endif %}
    class="application application-short {{ status.class }} status-all status-{{ status.class }}
        status-{{ app.status }}"
    data-collapsed-icon="{{ status.icon }}"
    data-expanded-icon="carat-d" data-role="collapsible"
    data-filtertext="{{ app.address.address }} {{app.number}} {{app.date}} {{app.carInfo.plateId}} {{app.userComment}} {{app.getCategory.short}} {% if recydywa > 1 %}recydywa{{ recydywa }}{% endif %}"
    title="Status: {{ status.name }}"
    >

    <h3>
        <span title="{{ app.number }}" class="app-number">{{ app.seq }}</span>
        {{ app.getDate }},
        {{ app.getShortAddress }}
        <sup>{%if app.guessSMData.isPolice %}#Policja{%else%}#SM</sup>{% endif %}
    </h3>

    <div data-role="listview" data-inset="false" class="ui-grid-a ui-responsive">
        <div class="ui-block-a">
            

            <p>{{ _self.icon('calendar') }}<b>{{ app.getHRDate }}</b> {{ app.getDateTimeDivider }} <b>{{ app.getTime }}</b></p>
            <p>{{ _self.icon('tag') }}<span class="plate-id">{{ app.carInfo.plateId }}</span>{% if recydywa > 1 %} <sup>(recydywa {{ recydywa }})</sup>{% endif %}</p>
            <p>{{ _self.icon('location') }}<a href="{{ app.getMapUrl }}" data-ajax="false" target="_blank">{{ app.getShortAddress }}</a></p>
            <p>{{ _self.icon('mail') }}Wysłano do <b>{{ app.guessSMData.getShortName }}</b></p>
        </div>
        <div class="ui-block-b">
            <p><b>{{ app.getCategory.title }}.</b> {{ app.getExtensionsText }} {% if app.userComment %}{{ app.getAHrefedComment | raw }}{% endif %}</p>
            <p>
            {% if app.statements is not defined or not app.statements.witness %}
                <b>Nie {{ app.guessUserSex.bylas }}</b> świadkiem parkowania.
            {% else %}
                <b>{{ app.guessUserSex.bylas|capitalize }} świadkiem</b> parkowania.</p>
            {% endif %}
            </p>
        </div>
    </div>

{% if status.topButtons %}
    <div>
        {% if app.automatedSM and autoSend is defined and autoSend %}
        <a href="#" onclick="sendApplication('{{ app.id }}');"
            data-inline="true" data-mini="true" 
            class="ui-btn ui-btn-inline ui-btn-icon-left ui-corner-all ui-nodisc-icon ui-mini
            {% if sendable %}cta{% else %}hidden{% endif %}
            ui-icon-{{ statuses['confirmed-waiting'].icon }}
            status-confirmed-waiting">Wyślij {% if sendable %}do {{ app.guessSMData.getShortName }}{% else %}zgłoszenie{% endif %}</a>
        {% elseif app.unknownSM %}
        <a href="/brak-sm.html?id={{ app.id }}"
            class="ui-btn ui-btn-inline ui-btn-icon-left ui-corner-all ui-nodisc-icon ui-mini ui-icon-mail
            {% if sendable %}cta{% else %}hidden{% endif %}
            status-confirmed-waiting">Wyślij zgłoszenie</a>
        {% elseif wysylka is not defined %}
        <a href="/wysylka.html?city={{ app.guessSMData.key|url_encode }}" data-ajax="false" 
            class="ui-btn ui-btn-inline ui-btn-icon-left ui-corner-all ui-nodisc-icon ui-mini ui-icon-mail status-confirmed-waiting
            {% if sendable %}cta{% else %}hidden{% endif %}">Wyślij zgłoszenie</a>
        {% endif %}
        {% if appActionButtons %}
        <a href="/nowe-zgloszenie.html?edit={{ app.id }}" data-ajax="false"
            class="ui-btn ui-btn-inline ui-btn-icon-left ui-corner-all ui-nodisc-icon ui-mini
            {% if not app.isEditable %}hidden{% endif %}
            ui-icon-edit ui-alt-icon">Edytuj</a>
        {% endif %}
    </div>

{% endif %}
    <div class="ui-grid-a ui-responsive images images-cropped">
        <div class="ui-block-a imageContainer">
            <div class="loader"></div>
            <a href="/ud-{{ app.id }}.html?dialog">
                <img class="lazyload" data-src="{{ app.contextImage.thumb }}?v={{ app.getRevision }}">
            </a>
        </div>
        <div class="ui-block-b imageContainer">
            <div class="loader"></div>
            <a href="/ud-{{ app.id }}.html?dialog">
                <img class="lazyload" data-src="{{ app.carImage.thumb }}?v={{ app.getRevision }}">
            </a>
        </div>
    </div>
{% if appActionButtons %}
    <p>Zmień ręcznie status zgłoszenia z <b class="currentStatus">{{ status.name }}</b> na:</p>
    <fieldset data-role="controlgroup" data-type="horizontal" data-mini="true" class="appActionButtons">
    {% for key,val in statuses %}
        {% if val.class == 'bottom' %}
            <a href="#" onclick="setStatus('{{ app.id }}', '{{ key }}')"
                data-inline="true" data-mini="true" 
                class="ui-btn ui-btn-inline ui-btn-icon-left ui-corner-all ui-nodisc-icon ui-mini
                {% if key not in status.allowed and key != app.status %}hidden{% endif %}
                {% if key == app.status %}ui-disabled{% endif %}
                {{ val.cta ?? '' }}
                ui-icon-{{ val.icon }}
                status-{{ key }}">{{ val.action }}</a>
        {% endif %}
    {% endfor %}
    </fieldset>
{% endif %}
    </p> <!-- data-role="listview" data-inset="false" -->
</div>