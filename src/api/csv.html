<?PHP
header("Content-Type: text/csv; charset=UTF-8");
require_once(__DIR__ . '/../../inc/include.php');
require(__DIR__ . '/../../autoload.php');

if (isset($_GET["file"]) && !empty($_GET["file"])) {
    $file = $_GET["file"];
    switch($file) {
        case "statsAppsByDay":
            _getStatsAppsByDay(); break;
        case "statsAppsByWeek":
            _getStatsAppsByWeek(); break;
        case "statsAppsByCity":
            _getStatsAppsByCity(); break;
        case "statsByDay":
            _getStatsByDay(); break;
        case "statsByYear":
            _getStatsByYear(); break;
        case "statsByCarBrand":
            _getStatsByCarBrand(); break;
        default: raiseError('Invalid file specified', 400);
    }
}else{
    raiseError('No file specified', 400);
}

function _getStatsAppsByDay(){
    GLOBAL $storage;
    $statsAppsByDay = $storage->getStatsAppsByDay(false);
    echo outputCSV($statsAppsByDay);
}

function _getStatsAppsByWeek(){
    GLOBAL $storage;
    $statsAppsByWeek = $storage->getStatsAppsByWeek(false);
    echo outputCSV($statsAppsByWeek);
}

function _getStatsByYear(){
    GLOBAL $storage;
    $statsByYear = $storage->getStatsByYear(false);
    echo outputCSV($statsByYear);
}

function _getStatsAppsByCity(){
    GLOBAL $storage;
    $statsAppsByCity = $storage->getStatsAppsByCity(false);
    echo outputCSV($statsAppsByCity);
}

function _getStatsByCarBrand(){
    GLOBAL $storage;
    $statsByCarBrand = $storage->getStatsByCarBrand(false);
    echo outputCSV($statsByCarBrand);
}

function _getStatsByDay(){
    GLOBAL $storage;
    $statsByDay = $storage->getStatsByDay(false);
    echo outputCSV($statsByDay);
}

function outputCSV($data) {
    $outputBuffer = fopen("php://output", 'w');
    foreach($data as $val) {
        fputcsv($outputBuffer, $val);
    }
    fclose($outputBuffer);
}

?>
