<?PHP
header("Content-Type: application/json; charset=UTF-8");
require_once(__DIR__ . '/../../inc/include.php');
require(__DIR__ . '/../../autoload.php');

if (is_ajax()) {
    if (isset($_POST["action"]) && !empty($_POST["action"])) {
        $action = $_POST["action"];
        logger("api.html:_ action=$action");
        switch($action) {
            case "verifyToken": _verifyToken(); break;
            case "archived":
            case "confirmed":
            case "confirmed-waiting":
            case "confirmed-waitingE":
            case "confirmed-sm":
            case "confirmed-ignored":
            case "confirmed-fined":
                _action($action, $_POST["id"]); break;
            case "upload":
                _upload(); break;
            default: raiseError('Invalid action specified', 400);
        }
    }else{
        raiseError('No action specified', 400);
    }
}else{
    raiseError('No AJAX request', 403);
}
  
function is_ajax() {
    return isset($_SERVER['HTTP_X_REQUESTED_WITH']) && strtolower($_SERVER['HTTP_X_REQUESTED_WITH']) == 'xmlhttprequest';
}

function _verifyToken(){
    if(isset($_POST['pa']) && !empty($_POST['pa'])){
        if(verifyToken($_POST['pa'])){
            echo json_encode(Array(
                'user_email' => $_SESSION['user_email'],
                'user_name' => $_SESSION['user_name'],
                'user_picture' => $_SESSION['user_picture'],
                'user_id' => $_SESSION['user_id']
            ));
        }else{
            logger('api.html:_verifyToken Token not verified');
            raiseError("Token not verified", 401);
        }
    }else{
        logger('api.html:_verifyToken Token not specified');
        raiseError("Token not specified", 400);
    }
}

function _action($action, $appId){
    global $storage;
    $application = $storage->getApplication($appId);
    $application->setStatus($action);
    $storage->saveApplication($application);
    $storage->getUserStats(false); // update cache
    echo json_encode(Array("status" => "OK"));
}

/**
 * Compares 'plate results' and sorts it by confidence.
 */
function cmp($a, $b){
    if($a['confidence'] > $b['confidence']) return -1;
    if($a['confidence'] < $b['confidence']) return 1;
    return 0;
}

/**
 * Saves uploaded image + automatically create thumbnail + read plate data
 * for `carImage`.
 */
function _upload(){
    global $_POST, $storage;
    $image_bytes = explode( ',', $_POST['image_data'])[1]; 
    $pictureType = $_POST['pictureType'];
    $applicationId = $_POST['applicationId'];

    try{
        $application = $storage->getApplication($applicationId);
    }catch(Exception $e){
        $application = new Application();
        $storage->saveApplication($application);
    }
    $type = substr($pictureType, 0, 2);
    $baseFileName = saveImgAndThumb($application, $image_bytes, $type);

    if($pictureType == 'carImage'){
        $car_info = get_car_info($image_bytes);

        $application->carImage = new stdClass();
        $application->carImage->url = "$baseFileName,$type.jpg";
        $application->carImage->thumb = "$baseFileName,$type,t.jpg";

        if(isset($car_info) && count($car_info["results"])){
            logger('ALPR (cost: ' . $car_info['credit_cost'] . ', this month: ' . 
                $car_info['credits_monthly_used'] . ', out of: ' .
                $car_info['credits_monthly_total'], true);

            $application->carInfo = new stdClass();

            $result = (Array)$car_info['results'];
            usort($result, "cmp");

            $result = $result[0];

            $coordinates = $result["coordinates"];
            $xes = Array();
            $yes = Array();
            foreach($coordinates as $ojb){
                $xes[] = $ojb->getX();
                $yes[] = $ojb->getY();
            }

            $im = imagecreatefromjpeg("/var/www/%HOST%/$baseFileName,$type.jpg");
            $plateImage = imagecrop($im, ['x' => min($xes), 'y' => min($yes), 'width' => (max($xes) - min($xes)), 'height' => (max($yes) - min($yes))]);
            if ($plateImage !== FALSE) {

                $application->carInfo->plateImage = "$baseFileName,$type,p.jpg";
                imagejpeg($plateImage, '/var/www/%HOST%/' . $application->carInfo->plateImage);
            }

            $recydywa = $storage->getRecydywa($result["plate"]);
            $application->carInfo->plateId = strtoupper($result["plate"]);
            $application->carInfo->plateIdFromImage = strtoupper($result["plate"]);
            $application->carInfo->brand = ucfirst($result["vehicle"]['make'][0]['name']);
            $application->carInfo->recydywa = $recydywa;
        }
    }else if($pictureType == 'contextImage'){
        $application->contextImage = new stdClass();
        $application->contextImage->url = "$baseFileName,$type.jpg";
        $application->contextImage->thumb = "$baseFileName,$type,t.jpg";
    }else{
        raiseError("Uknown picture type: " . $pictureType, 400);
    }

    $storage->saveApplication($application);
    echo json_encode($application);
}

/**
 * https://staging.uprzejmiedonosze.net/cdn/6cab0aa0-3317-478d-97a3-31d278db5861,t.jpg
 * https://%HOST%/cdn/$HASH$THUMB.jpg » __DIR__/../../../cdn/$HASH$THUMB.jpg
 * https://%HOST%/$prefix$type.jpg » __DIR__/../../../cdn/$prefix$type.jpg
 */

/**
 * Saves byte_stream to `ROOT/userId/appId,type.jpg`
 * and it's thumb to    `ROOT/userId/appId,typet.jpg`
 * 
 * Returns:
 *   $prefix
*/
function saveImgAndThumb($application, $image_bytes, $type){
    $baseDir = 'cdn2/' . $application->getUserNumber();
    if(!file_exists('/var/www/%HOST%/' . $baseDir)){
        mkdir('/var/www/%HOST%/' . $baseDir, 0755, true);
    }
    $baseFileName = $baseDir . '/' . $application->id;
    
    $fileName     = "/var/www/%HOST%/$baseFileName,$type.jpg";
    $thumbName    = "/var/www/%HOST%/$baseFileName,$type,t.jpg";
    $ifp = @fopen($fileName, 'wb');
    if($ifp === false){
        raiseError("Can't open $fileName for write", 500);
    }
    
	if(fwrite($ifp, base64_decode($image_bytes)) === false){
        raiseError("Can't write to $fileName", 500);
    }
    fclose($ifp);

	if(!imagejpeg(resize_image($fileName, 600, 600, false), $thumbName)){
        logger("Wasn't able to write $fileName as thumb to $thumbName.", true);
    }
    return $baseFileName;
}

/**
 * Get's car info from image.
 * 
 * Returns:
 *  object
 *  null on error
 */
function get_car_info($image_bytes){
	$api_instance = new Swagger\Client\Api\DefaultApi();
    $secret_key = (intval(date('i')) % 2)? // mixing two API keys
        "sk_0bcc0e58dab1ea40c4389d70": // SZN key
        "sk_aa0b80a70b2ae2268b36734a"; // KS key
	$country = "eu"; 
	$recognize_vehicle = 1;
	$state = ""; 
	$return_image = 0; 
	$topn = 1; 
	$prewarp = ""; 

	try {
		return $api_instance->recognizeBytes($image_bytes, $secret_key, $country, $recognize_vehicle, $state, $return_image, $topn, $prewarp);
	} catch (Exception $e) {
		logger('Exception when calling DefaultApi->recognizeBytes: ' . $e->getMessage(), true);
		return null;
	}
}

/**
 * Resizes given .jpg file data_stream.
 * 
 * Returns:
 *   destination image link resource
 */
function resize_image($file, $w, $h, $crop=FALSE) {
	list($width, $height) = getimagesize($file);
	$r = $width / $height;
	if ($crop) {
		if ($width > $height) {
			$width = ceil($width-($width*abs($r-$w/$h)));
		} else {
			$height = ceil($height-($height*abs($r-$w/$h)));
		}
		$newwidth = $w;
		$newheight = $h;
	} else {
		if ($w/$h > $r) {
			$newwidth = $h*$r;
			$newheight = $h;
		} else {
			$newheight = $w/$r;
			$newwidth = $w;
		}
	}
	$src = imagecreatefromjpeg($file);
	$dst = imagecreatetruecolor($newwidth, $newheight);
	imagecopyresampled($dst, $src, 0, 0, 0, 0, $newwidth, $newheight, $width, $height);

	return $dst;
}

?>
