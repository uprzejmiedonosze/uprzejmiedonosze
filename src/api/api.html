<?PHP
header("Content-Type: application/json; charset=UTF-8");
require_once(__DIR__ . '/../../inc/include.php');
require(__DIR__ . '/../../autoload.php');
require(__DIR__ . '/../../inc/alpr.php');

$cache = new Memcache;
$cache->connect('localhost', 11211);

if(isset($_GET["action"]) && $_GET["action"] == "initLogs"){
    _initLogs();
    die();
}

if (is_ajax()) {
    if (isset($_POST["action"]) && !empty($_POST["action"])) {
        $action = $_POST["action"];
        switch($action) {
            case "verifyToken": _verifyToken(); break;
            case "archived":
            case "confirmed":
            case "confirmed-waiting":
            case "confirmed-waitingE":
            case "confirmed-sm":
            case "confirmed-ignored":
            case "confirmed-fined":
            case "confirmed-instructed":
                _setStatus($action, $_POST["id"]); break;
            case "send":
                _send($_POST["id"]); break;
            case "upload":
                _upload(); break;
            case "getApp":
                _getAppDetails($_POST["id"]); break;
            case "geoToAddress":
                _geoToAddress($_POST["lat"], $_POST["lng"]); break;
            case "addToGallery":
                _addToGallery($_POST["id"]); break;
            case "moderateApp":
                _moderateApp($_POST["id"], $_POST["decision"]); break;
            case "getAppByNumber":
                _getAppByNumber($_POST["number"], $_POST["apiToken"]); break;
            case "getUserByName":
                _getUserByName($_POST["name"], $_POST["apiToken"]); break;
            default: raiseError('Invalid action specified', 400);
        }
    }else{
        raiseError('No action specified', 400);
    }
}else{
    raiseError('No AJAX request', 403);
}
  
function is_ajax() {
    return isset($_SERVER['HTTP_X_REQUESTED_WITH']) && strtolower($_SERVER['HTTP_X_REQUESTED_WITH']) == 'xmlhttprequest';
}

function _verifyToken(){
    if(isset($_POST['pa']) && !empty($_POST['pa'])){
        if(verifyToken($_POST['pa'])){
            echo json_encode(Array(
                'user_email' => $_SESSION['user_email'],
                'user_name' => $_SESSION['user_name'],
                'user_picture' => $_SESSION['user_picture'],
                'user_id' => $_SESSION['user_id']
            ));
        }else{
            logger('api.html:_verifyToken Token not verified');
            raiseError("Token not verified", 401);
        }
    }else{
        logger('api.html:_verifyToken Token not specified');
        raiseError("Token not specified", 400);
    }
}

/**
 * Sets application status.
 */
function _setStatus($status, $appId){
    global $storage;
    $application = $storage->getApplication($appId);
    try{
        $application->setStatus($status);
    }catch(Exception $e){
        \Sentry\captureException($e);
        raiseError($e->getMessage(), 500);
    }
    $storage->saveApplication($application);
    $storage->updateRecydywa($application->carInfo->plateId);
    $storage->getUserStats(false); // update cache
    echo json_encode(Array("status" => "OK"));
}

/**
 * Sends application to SM via API (if possible), and updates status.
 */
function _send($appId){
    global $storage;
    try{
        $application = $storage->getApplication($appId);
        $sm = $application->guessSMData();

        if(!$sm->api){
            throw new Exception("SM " . $sm->city . " nie posiada API");
        }

        require(__DIR__ . '/../../inc/integrations/CityAPI.php');
        $api = new $sm->api;
        $newStatus = $api->send($application);
        _sendSlackOnNewApp($application);
    }catch(Exception $e){
        \Sentry\captureException($e);
        raiseError($e->getMessage(), 500);
    }
    echo json_encode(Array("status" => "$newStatus"));
}

/**
 * Returns app details JSON
 */
function _getAppDetails($appId){
    global $storage;
    try{
        $application = $storage->getApplication($appId);
    }catch(Exception $e){
        \Sentry\captureException($e);
        raiseError($e->getMessage(), 404);
    }
    echo json_encode($application);
}

/**
 * 
 */

function _geoToAddress($lat, $lng){
    global $cache;
    $latlng = number_format((float) $lat, 4, '.', '') . ',' . number_format((float) $lng, 4, '.', '');

    $result = $cache->get("_geoToAddress-$latlng");
    if($result){
        logger("_geoToAddress cache-hit $latlng");
        echo json_encode($result);
        return;
    }
    logger("_geoToAddress cache-miss $latlng");

    $ch = curl_init("https://maps.googleapis.com/maps/api/geocode/json?latlng=$latlng&key=AIzaSyC2vVIN-noxOw_7mPMvkb-AWwOk6qK1OJ8&language=pl&result_type=street_address");
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    $output = curl_exec($ch);
    if(curl_errno($ch)){
        logger("Nie udało się pobrać danych latlng: " . curl_error($ch));
        raiseError("Nie udało się pobrać odpowiedzi z serwerów GeoAPI: " . curl_error($ch), 500);
        curl_close($ch);
        return;
    }
    curl_close($ch);

    $json = @json_decode($output, true);
    if(!json_last_error() === JSON_ERROR_NONE){
        logger("Parsowanie JSON z Google Maps APIS " . $output . " " . json_last_error_msg());
        raiseError("Bełkotliwa odpowiedź z serwerów GeoAPI: " . $output, 500);
        return;
    }
    if($json['status'] == 'OK' && $json['results']){
        @$result = $json['results'][0];
        $cache->set("_geoToAddress-$latlng", $result, MEMCACHE_COMPRESSED, 0);
        echo json_encode($result);
        return;
    }
    if($json['status'] == 'ZERO_RESULTS'){
        raiseError("Brak wyników z serwerów GeoAPI dla $lat, $lng: $output", 404, false);
    }
    raiseError("Niepoprawna odpowiedź z serwerów GeoAPI: " . $output, 500);
}

function _addToGallery($appId){
    global $storage;

    $application = $storage->getApplication($appId);
    if(!$application->isCurrentUserOwner()){
        raiseError("Próba zmiany cudzego zgłoszenia $appId!", 401);
    }

    $application->initStatements();
    $application->statements->gallery = date(DT_FORMAT);
    $storage->saveApplication($application);

    echo json_encode(Array("status" => "OK"));
}

function _moderateApp($appId, $decision){
    require __DIR__ . '/../../inc/Tumblr.php';
    global $storage;
    if(!isAdmin()){
        raiseError("Dostęp zabroniony", 401);
    }

    $application = $storage->getApplication($appId);

    if($decision == 'true'){
        try{
            $application->addedToGallery = addToTumblr($application);
            $application->addComment('admin', "Zdjęcie dodane do galerii.");
        } catch (Exception $ex) {
            $application->addedToGallery = null;
            raiseError("Błąd Tumblr " . print_r($ex, true) , 500);
        }
    }else{
        $application->addedToGallery = false;
    }
    
    $storage->saveApplication($application);
    echo json_encode(Array("status" => "OK"));
}

/**
 * Saves uploaded image + automatically create thumbnail + read plate data
 * for `carImage`.
 */
function _upload(){
    global $_POST, $storage;
    $image_bytes = explode( ',', $_POST['image_data'])[1]; 
    $pictureType = $_POST['pictureType'];
    $applicationId = $_POST['applicationId'];

    $semKey = $storage->getCurrentUser()->getNumber();
    $semaphore = sem_get($semKey, 1, 0666, 1);
    sem_acquire($semaphore);

    try{
        $application = $storage->getApplication($applicationId);
    }catch(Exception $e){
        $application = new Application();
        $storage->saveApplication($application);
    }

    $type = substr($pictureType, 0, 2);
    $baseFileName = saveImgAndThumb($application, $image_bytes, $type);

    if($pictureType == 'carImage'){
        get_car_info($image_bytes, $application, $baseFileName, $type);
    }else if($pictureType == 'contextImage'){
        $application->contextImage = new stdClass();
        $application->contextImage->url = "$baseFileName,$type.jpg";
        $application->contextImage->thumb = "$baseFileName,$type,t.jpg";
    }else{
        sem_release($semaphore);
        raiseError("Unknown picture type: $pictureType ($applicationId)", 400);
    }

    $storage->saveApplication($application);
    sem_release($semaphore);
    echo json_encode($application);
}

/**
 * https://staging.uprzejmiedonosze.net/cdn/6cab0aa0-3317-478d-97a3-31d278db5861,t.jpg
 * https://%HOST%/cdn/$HASH$THUMB.jpg » __DIR__/../../../cdn/$HASH$THUMB.jpg
 * https://%HOST%/$prefix$type.jpg » __DIR__/../../../cdn/$prefix$type.jpg
 */

/**
 * Saves byte_stream to `ROOT/userId/appId,type.jpg`
 * and it's thumb to    `ROOT/userId/appId,typet.jpg`
 * 
 * Returns:
 *   $prefix
*/
function saveImgAndThumb($application, $image_bytes, $type){
    $baseDir = 'cdn2/' . $application->getUserNumber();
    if(!file_exists('/var/www/%HOST%/' . $baseDir)){
        mkdir('/var/www/%HOST%/' . $baseDir, 0755, true);
    }
    $baseFileName = $baseDir . '/' . $application->id;
    
    $fileName     = "/var/www/%HOST%/$baseFileName,$type.jpg";
    $thumbName    = "/var/www/%HOST%/$baseFileName,$type,t.jpg";
    $ifp = @fopen($fileName, 'wb');
    if($ifp === false){
        raiseError("Can't open $fileName for write", 500);
    }
    
	if(fwrite($ifp, base64_decode($image_bytes)) === false){
        raiseError("Can't write to $fileName", 500);
    }
    fclose($ifp);

	if(!imagejpeg(resize_image($fileName, 600, 600, false), $thumbName)){
        logger("Wasn't able to write $fileName as thumb to $thumbName.", true);
    }
    return $baseFileName;
}

/**
 * Resizes given .jpg file data_stream.
 * 
 * Returns:
 *   destination image link resource
 */
function resize_image($file, $w, $h, $crop=FALSE) {
	list($width, $height) = getimagesize($file);
	$r = $width / $height;
	if ($crop) {
		if ($width > $height) {
			$width = ceil($width-($width*abs($r-$w/$h)));
		} else {
			$height = ceil($height-($height*abs($r-$w/$h)));
		}
		$newwidth = $w;
		$newheight = $h;
	} else {
		if ($w/$h > $r) {
			$newwidth = $h*$r;
			$newheight = $h;
		} else {
			$newheight = $w/$r;
			$newwidth = $w;
		}
	}
	$src = imagecreatefromjpeg($file);
	$dst = imagecreatetruecolor($newwidth, $newheight);
	imagecopyresampled($dst, $src, 0, 0, 0, 0, $newwidth, $newheight, $width, $height);

	return $dst;
}

function _initLogs() {
    logger("INIT %VERSION%", true);
}

function _getAppByNumber($number, $apiToken){
    global $storage;
    try{
        $application = $storage->getAppByNumber($number, $apiToken);
    }catch(Exception $e){
        \Sentry\captureException($e);
        raiseError($e->getMessage(), 404);
    }
    echo json_encode($application);
}

function _getUserByName($name, $apiToken){
    global $storage;
    try{
        $user = $storage->getUserByName($name, $apiToken);
    }catch(Exception $e){
        \Sentry\captureException($e);
        raiseError($e->getMessage(), 404);
    }
    echo json_encode($user);
}


?>
