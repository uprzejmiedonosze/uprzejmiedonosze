<?PHP
header("Content-Type: application/json; charset=UTF-8");

require(__DIR__ . '/../../inc/API.php');
require(__DIR__ . '/../../inc/APIUtils.php');

if(isset($_GET["action"]) && $_GET["action"] == "initLogs"){
    initLogs();
    die();
}

if (isAjax()) {
    if (isset($_POST["action"]) && !empty($_POST["action"])) {
        $action = $_POST["action"];
        switch($action) {
            case "verifyToken": 
                if (isset($_POST['jwt']) && !empty($_POST['jwt'])) {
                    verifyToken($_POST['jwt']);
                    echo json_encode(array(
                        'user_email' => $_SESSION['user_email'],
                        'user_name' => $_SESSION['user_name'],
                        'user_picture' => $_SESSION['user_picture'],
                        'user_id' => $_SESSION['user_id']
                    ));
                    break;
                }
                raiseError("Token not specified", 400);
                break;
            case "archived":
            case "confirmed":
            case "confirmed-waiting":
            case "confirmed-waitingE":
            case "confirmed-sm":
            case "confirmed-ignored":
            case "confirmed-fined":
            case "confirmed-instructed":
                setStatus($action, $_POST["id"]); break;
            case "send":
                sendApplication($_POST["id"]); break;
            case "upload":
                $imageBytes = explode( ',', $_POST['image_data'])[1]; 
                $pictureType = $_POST['pictureType'];
                $appId = $_POST['applicationId'];
                $dateTime = $_POST['dateTime'];
                $dtFromPicture = $_POST['dtFromPicture'] == 'true';
                $latLng = $_POST['latLng'];
                uploadImage($appId, $pictureType, $imageBytes, $dateTime, $dtFromPicture, $latLng);
                break;
            case "getApp":
                getAppDetails($_POST["id"]); break;
            case "geoToAddress":
                geoToAddress($_POST["lat"], $_POST["lng"]); break;
            case "addToGallery":
                addToGallery($_POST["id"]); break;
            case "moderateApp":
                moderateApp($_POST["id"], $_POST["decision"]); break;
            case "getAppByNumber":
                getAppByNumber($_POST["number"], $_POST["apiToken"]); break;
            case "getUserByName":
                getUserByName($_POST["name"], $_POST["apiToken"]); break;
            default: raiseError('Invalid action specified', 400);
        }
    }else{
        raiseError('No action specified', 400);
    }
}else{
    raiseError('No AJAX request', 403);
}

?>
