<?PHP

require_once(__DIR__ . '/../../../inc/include.php');
require(__DIR__ . '/../../../inc/API.php');

header("Content-Type: application/json; charset=UTF-8");
header("Access-Control-Allow-Headers: Content-Type, Authorization");
header("Access-Control-Allow-Methods: POST, GET");
header("Access-Control-Allow-Credentials: true");
header("Access-Control-Allow-Origin: *");


use Firebase\JWT\JWT;
use Firebase\JWT\Key;
use Firebase\JWT\SignatureInvalidException;
use Firebase\JWT\BeforeValidException;
use Firebase\JWT\ExpiredException;
use \Memcache as Memcache;

$ACTIONS = [
    'upload' => true,
    'set-status' => true,
    'send-application' => true,

    'geo-to-address' => false,
    'get-application' => false,
    'sm' => false,
    'categories' => false,
    'extensions' => false,
    'statuses' => false,
    'stop-agresji' => false
];

$action = detectAction();

if (needAuth($action)) {
    validateJWT();
}

try {
    switch ($action) {
        case 'upload': // POST
            $imageBytes = uploadedFileToBase64(); // requires file named 'image' 
            $pictureType = $_POST['pictureType']; // carImage|contextImage
            $appId = $_POST['id']; // application id
            uploadImage($appId, $pictureType, $imageBytes);
            break;
        case 'set-status':  // POST
            $appId = $_POST["id"]; // application id
            $newStatus = $_POST["status"]; // see statuses.json
            setStatus($newStatus, $appId);
            break;
        case 'send-application':  // POST
            $appId = $_POST["id"]; // application id
            sendApplication($appId);
            break;
        case 'geo-to-address': // GET
            $lat = $_GET["lat"];
            $lng = $_GET["lng"];
            geoToAddress($lat, $lng);
            break;
        case 'get-application': // GET
            $appId = $_GET["id"]; // application id
            getAppDetails($appId);
            break;
        case "sm": // GET
            echo file_get_contents(__DIR__ . "/../config/sm.json");
            break;
        case 'categories': // GET
            echo file_get_contents(__DIR__ . "/../config/categories.json");
            break;
        case 'extensions': // GET
            echo file_get_contents(__DIR__ . "/../config/extensions.json");
            break;
        case 'statuses': // GET
            echo file_get_contents(__DIR__ . "/../config/statuses.json");
            break;
        case 'stop-agresji': // GET
            echo file_get_contents(__DIR__ . "/../config/stop-agresji.json");
            break;
    }
} catch (Exception $e) {
    raiseError("$e", 500);
} catch (Throwable $e) {
    raiseError("$e", 500);
}

// API utils

function detectAction() {
    global $_GET, $_POST, $ACTIONS;
    $action = null;
    isset($_GET["action"]) && $action = $_GET["action"];
    isset($_POST["action"]) && $action = $_POST["action"];
    if (is_null($action))
        raiseError('GET or POST action paremeter is missing', 400);
    if (!in_array($action, array_keys($ACTIONS)))
        raiseError("'$action' is not implemented", 501);
    return $action;
}

function needAuth($action) {
    global $ACTIONS;
    return $ACTIONS[$action];
}

// AUTH utils

function validateJWT() {
    global $_SERVER;
    $algorithm = 'RS256';

    if (!isset($_SERVER['HTTP_AUTHORIZATION']) || !preg_match('/Bearer\s(\S+)/', $_SERVER['HTTP_AUTHORIZATION'], $matches)) {
        raiseError("Token not found in request", 400);
    }
    $jwt = $matches[1];
    if (!$jwt)
        raiseError("Token not found in request", 400);

    $keys  = getPublicKeys();
    $kid = decodeKid($jwt);
    if (!isset($keys[$kid]))
        raiseError("Wrong `kid` in JWT header", 400);
    $key = $keys[$kid];

    try {
        $token = JWT::decode($jwt, new Key($key, $algorithm));
    } catch (InvalidArgumentException $e) {
        raiseError("$e", 401);
    } catch (DomainException $e) {
        // provided algorithm is unsupported OR provided key is invalid
        raiseError("$e", 401);
    } catch (SignatureInvalidException $e) {
        // provided JWT signature verification failed.
        raiseError("$e", 401);
    } catch (BeforeValidException $e) {
        raiseError("$e", 401);
        // provided JWT is trying to be used before "nbf" claim OR before "iat" claim
    } catch (ExpiredException $e) {
        // provided JWT is trying to be used after "exp" claim.
        raiseError("$e", 401);
    } catch (UnexpectedValueException $e) {
        // provided JWT is malformed OR
        // provided JWT is missing an algorithm / using an unsupported algorithm OR
        // provided JWT algorithm does not match provided key OR
        // provided key ID in key/key-array is empty or invalid.
        raiseError("$e", 401);
    }

    if (!verifyToken($jwt)) {
        raiseError("Internal JWT verification failed", 401);
    }

    return $token;
}

/**
 * Retrieves (cached) public keys from Firebase's server
 */
function getPublicKeys() {
    $publicKeyUrl = 'https://www.googleapis.com/robot/v1/metadata/x509/securetoken@system.gserviceaccount.com';

    $cache = new Memcache;
    $cache->connect('localhost', 11211);
    $cacheKey = "%HOST%-firebase-keys";

    $keys = $cache->get($cacheKey);
    if ($keys) return json_decode($keys, true);

    $publicKeys = file_get_contents($publicKeyUrl);
    if (!$publicKeys)
        raiseError('Failed to fetch JWT public keys.', 501);

    $cacheControl = parseHeaders($http_response_header)['Cache-Control'];
    preg_match('/max-age=(\d+)/', $cacheControl, $out);
    $timeout = $out[1];
    $cache->set($cacheKey, $publicKeys, 0, (int)$timeout);

    return json_decode($publicKeys, true);
}

/**
 * Retrieves key_id from JWT.
 * 
 * @SuppressWarnings(PHPMD.UnusedLocalVariable)
 */
function decodeKid($jwt) {
    list($headersB64, $payloadB64, $sig) = explode('.', $jwt);
    $decoded = json_decode(base64_decode($headersB64), true);
    if (!isset($decoded['kid']))
        raiseError('Missing `kid` in JWT header', 501);
    return $decoded['kid'];
}
