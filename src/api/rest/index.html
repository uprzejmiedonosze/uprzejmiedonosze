<?PHP

require_once(__DIR__ . '/../../../inc/include.php');
require(__DIR__ . '/../../../inc/API.php');
require(__DIR__ . '/../../../inc/APIUtils.php');

header('Content-Type: application/json; charset=UTF-8');
header('Access-Control-Allow-Headers: Content-Type, Authorization');
header('Access-Control-Allow-Methods: POST, GET');
header('Access-Control-Allow-Credentials: true');
header('Access-Control-Allow-Origin: *');


use Firebase\JWT\JWT;
use Firebase\JWT\Key;
use Firebase\JWT\SignatureInvalidException;
use Firebase\JWT\BeforeValidException;
use Firebase\JWT\ExpiredException;
use \Memcache as Memcache;

$ACTIONS = [
    'get-user' => true,
    'register-user' => true,
    'update-user' => true,
    'user-apps' => true,

    'upload-app-image' => true,
    'set-app-status' => true,
    'send-app' => true,
    'get-app' => false,
    'update-app' => true,

    'geo-to-address' => false,

    'config-sm' => false,
    'config-categories' => false,
    'config-extensions' => false,
    'config-statuses' => false,
    'config-stop-agresji' => false
];

$action = detectAction();

if (needAuth($action)) {
    validateJWT();
    if ($action !== 'register-user')
        checkRegistrationStatus();
}

try {
    switch ($action) {
        case 'get-user': // GET
            $user = $storage->getCurrentUser();
            echo json_encode($user);
            break;
        case 'register-user': // POST
            $name = capitalizeName(getParam('POST', 'name'));
            $address = str_replace(', Polska', '', getParam('POST', 'address'));
            $msisdn = getParam('POST', 'msisdn', '');
            $exposeData = (bool) (getParam('POST', 'exposeData', 'N') == 'Y');
            try {
                $user = $storage->getCurrentUser();
            } catch (Exception $e) {
                $user = new User();
            }
            $user->updateUserData($name, $msisdn, $address, $exposeData, false, true, 200);
            $storage->saveUser($user);
            break;
        case 'update-user': // POST
            $name = capitalizeName(getParam('POST', 'name'));
            $address = str_replace(', Polska', '', getParam('POST', 'address'));
            $msisdn = getParam('POST', 'msisdn', '');
            $exposeData = (bool) (getParam('POST', 'exposeData', 'N') == 'Y');
            $stopAgresji = (bool) (getParam('POST', 'stopAgresji', 'SM') == 'SA');
            $autoSend = (bool) (getParam('POST', 'autoSend', 'Y') == 'Y');
            $myAppsSize = getParam('POST', 'myAppsSize', 200);
            try {
                $user = $storage->getCurrentUser();
            } catch (Exception $e) {
                raiseError('Attempt to update non-existing user!', 404);
            }
            $user->updateUserData($name, $msisdn, $address, $exposeData, $stopAgresji, $autoSend, $myAppsSize);
            $storage->saveUser($user);
            break;

        case 'user-apps': // GET
            $status = getParam('GET', 'status', 'all');
            $search = getParam('GET', 'search', '%');
            $limit = getParam('GET', 'limit', 0); // 0 == no limit
            $offset = getParam('GET', 'offset', 0);
            $apps = $storage->getUserApplications($status, $search, $limit, $offset);
            echo json_encode($apps);
            break;

        case 'upload-app-image': // POST
            $imageBytes = uploadedFileToBase64(); // requires file named 'image'
            $pictureType = getParam('POST', 'pictureType');  // carImage|contextImage
            $appId = getParam('POST', 'id'); // application id
            uploadImage($appId, $pictureType, $imageBytes);
            break;
        case 'set-app-status':  // POST
            $appId = getParam('POST', 'id'); // application id
            $newStatus = getParam('POST', 'status'); // see statuses.json
            setStatus($newStatus, $appId);
            break;
        case 'update-app': // POST
            $appId = getParam('POST', 'id'); // application id
            $plateId = getParam('POST', 'plateId');
            $address = getParam('POST', 'address'); // Mazurska 37, Szczecin
            $city = getParam('POST', 'city');
            $voivodeship = getParam('POST', 'voivodeship');
            $country = getParam('POST', 'country');
            $district = getParam('POST', 'district');
            $dtFromPicture = (bool)getParam('POST', 'dtFromPicture'); // 1|0

            $datetime = getParam('POST', 'datetime'); // "2018-02-02T19:48:10"

            $latlng = getParam('POST', 'latlng'); // 53.431786,14.551586
            $comment = getParam('POST', 'comment', '');
            $category = intval(getParam('POST', 'category'));

            $extensions = getParam('POST', 'extensions', ''); // "6,7", "6", "", missing
            $extensions = array_filter(explode(',', $extensions));

            $fullAddress = new JSONObject();
            $fullAddress->address = $address;
            $fullAddress->city = $city;
            $fullAddress->voivodeship = $voivodeship;
            $fullAddress->latlng = $latlng;
            $fullAddress->district = $district;
            
            try {
                updateApplication($appId, $date, $dtFromPicture, $category, $fullAddress,
                    $plateId, $comment, $witness, $extensions);
            } catch (Exception $e) {
                raiseError("$e", 403);
            }
            break;

        case 'send-app':  // POST
            $appId = getParam('POST', 'id'); // application id
            sendApplication($appId);
            break;
        case 'get-app': // GET
            $appId = getParam('GET', 'id'); // application id
            getAppDetails($appId);
            break;
    
        case 'geo-to-address': // GET
            $lat = getParam('GET', 'lat');
            $lng = getParam('GET', 'lng');
            geoToAddress($lat, $lng);
            break;
        case 'config-sm': // GET
            echo file_get_contents(__DIR__ . '/../config/sm.json');
            break;
        case 'config-categories': // GET
            echo file_get_contents(__DIR__ . '/../config/categories.json');
            break;
        case 'config-extensions': // GET
            echo file_get_contents(__DIR__ . '/../config/extensions.json');
            break;
        case 'config-statuses': // GET
            echo file_get_contents(__DIR__ . '/../config/statuses.json');
            break;
        case 'config-stop-agresji': // GET
            echo file_get_contents(__DIR__ . '/../config/stop-agresji.json');
            break;
    }
} catch (Exception $e) {
    raiseError("$e", 500);
} catch (Throwable $e) {
    raiseError("$e", 500);
}

// API utils

function detectAction() {
    global $_GET, $_POST, $ACTIONS;
    $action = null;
    isset($_GET['action']) && $action = $_GET['action'];
    isset($_POST['action']) && $action = $_POST['action'];
    if (is_null($action))
        raiseError('GET or POST action paremeter is missing', 400);
    if (!in_array($action, array_keys($ACTIONS)))
        raiseError("'$action' is not implemented", 501);
    return $action;
}

function needAuth($action) {
    global $ACTIONS;
    return $ACTIONS[$action];
}

// AUTH utils

function validateJWT() {
    global $_SERVER;
    $algorithm = 'RS256';

    if (!isset($_SERVER['HTTP_AUTHORIZATION']) || !preg_match('/Bearer\s(\S+)/', $_SERVER['HTTP_AUTHORIZATION'], $matches)) {
        raiseError('Token not found in request', 400);
    }
    $jwt = $matches[1];
    if (!$jwt)
        raiseError('Token not found in request', 400);

    $keys  = getPublicKeys();
    $kid = decodeKid($jwt);
    if (!isset($keys[$kid]))
        raiseError('Wrong `kid` in JWT header', 400);
    $key = $keys[$kid];

    try {
        $token = JWT::decode($jwt, new Key($key, $algorithm));
    } catch (InvalidArgumentException $e) {
        raiseError("$e", 401);
    } catch (DomainException $e) {
        // provided algorithm is unsupported OR provided key is invalid
        raiseError("$e", 401);
    } catch (SignatureInvalidException $e) {
        // provided JWT signature verification failed.
        raiseError("$e", 401);
    } catch (BeforeValidException $e) {
        raiseError("$e", 401);
        // provided JWT is trying to be used before "nbf" claim OR before "iat" claim
    } catch (ExpiredException $e) {
        // provided JWT is trying to be used after "exp" claim.
        raiseError("$e", 401);
    } catch (UnexpectedValueException $e) {
        // provided JWT is malformed OR
        // provided JWT is missing an algorithm / using an unsupported algorithm OR
        // provided JWT algorithm does not match provided key OR
        // provided key ID in key/key-array is empty or invalid.
        raiseError("$e", 401);
    }

    if (!verifyToken($jwt)) {
        raiseError('Internal JWT verification failed', 401);
    }

    return $token;
}

