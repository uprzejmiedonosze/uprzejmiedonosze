<?PHP

require_once(__DIR__ . '/../../../inc/include.php');
require(__DIR__ . '/../../../inc/API.php');
require(__DIR__ . '/../../../inc/APIUtils.php');

header('Content-Type: application/json; charset=UTF-8');
header('Access-Control-Allow-Headers: Content-Type, Authorization');
header('Access-Control-Allow-Methods: POST, GET');
header('Access-Control-Allow-Credentials: true');
header('Access-Control-Allow-Origin: *');


use Firebase\JWT\JWT;
use Firebase\JWT\Key;
use Firebase\JWT\SignatureInvalidException;
use Firebase\JWT\BeforeValidException;
use Firebase\JWT\ExpiredException;
use \Memcache as Memcache;

$ACTIONS = [];

//if (needAuth($action)) {
    validateJWT();
    if ($action !== 'register-user')
        checkRegistrationStatus();
//}

try {
    switch ($action) {
        case 'get-user-stats': // GET
            // @TODO draft
            $user = $storage->getCurrentUser();
            // select case when json_extract(value, '$.statements.gallery') != 0 then 'zgoda' else 'brak zgody' end as statement,
            //   case json_extract(value, '$.addedToGallery') = 0 when 1 then 'odrzucone' when 0 then 'zaakceptowane' else '   ' end as decyzja,
            //   count(*) from applications where ${WHERE2} group by 1, 2 ;
            echo json_encode($user);
        case 'upload-app-image': // POST
            $imageBytes = uploadedFileToBase64(); // requires file named 'image'
            $pictureType = getParam('POST', 'pictureType');  // carImage|contextImage
            $appId = getParam('POST', 'id'); // application id
            
            // valid only for $pictureType == 'carImage'
            $dateTime = getParam('POST', 'dateTime', ''); // date&time of application event, in ISO format: "2018-02-02T19:48:10"
            $dtFromPicture = (bool)getParam('POST', 'dtFromPicture', ''); // 1|0 - was date and time extracted from picture?
            $latLng = getParam('POST', 'latLng', ''); // lat,lng: 53.431786,14.551586
            uploadImage($appId, $pictureType, $imageBytes, $dateTime, $dtFromPicture, $latLng);
            break;
        case 'set-app-status':  // POST
            $appId = getParam('POST', 'id'); // application id
            $newStatus = getParam('POST', 'status'); // see statuses.json
            setStatus($newStatus, $appId);
            break;

        case 'send-app':  // POST
            $appId = getParam('POST', 'id'); // application id
            sendApplication($appId);
            break;
    }
} catch (Exception $e) {
    raiseError("$e", 500);
} catch (Throwable $e) {
    raiseError("$e", 500);
}

// AUTH utils

function validateJWT() {
    global $_SERVER;
    $algorithm = 'RS256';

    if (!isset($_SERVER['HTTP_AUTHORIZATION']) || !preg_match('/Bearer\s(\S+)/', $_SERVER['HTTP_AUTHORIZATION'], $matches)) {
        raiseError('Token not found in request', 400);
    }
    $jwt = $matches[1];
    if (!$jwt)
        raiseError('Token not found in request', 400);

    $keys  = getPublicKeys();
    $kid = decodeKid($jwt);
    if (!isset($keys[$kid]))
        raiseError('Wrong `kid` in JWT header', 400);
    $key = $keys[$kid];

    try {
        $token = JWT::decode($jwt, new Key($key, $algorithm));
    } catch (InvalidArgumentException $e) {
        raiseError("$e", 401);
    } catch (DomainException $e) {
        // provided algorithm is unsupported OR provided key is invalid
        raiseError("$e", 401);
    } catch (SignatureInvalidException $e) {
        // provided JWT signature verification failed.
        raiseError("$e", 401);
    } catch (BeforeValidException $e) {
        raiseError("$e", 401);
        // provided JWT is trying to be used before "nbf" claim OR before "iat" claim
    } catch (ExpiredException $e) {
        // provided JWT is trying to be used after "exp" claim.
        raiseError("$e", 401);
    } catch (UnexpectedValueException $e) {
        // provided JWT is malformed OR
        // provided JWT is missing an algorithm / using an unsupported algorithm OR
        // provided JWT algorithm does not match provided key OR
        // provided key ID in key/key-array is empty or invalid.
        raiseError("$e", 401);
    }

    if (!verifyToken($jwt)) {
        raiseError('Internal JWT verification failed', 401);
    }

    return $token;
}

