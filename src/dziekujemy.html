<?PHP
require_once __DIR__ . '/../inc/include.php';

if (!isset($_SESSION['newAppId']) || !isset($_POST['applicationId'])) {
    redirect('moje-zgloszenia.html');
}

$applicationId = $_POST['applicationId'];
unset($_SESSION['newAppId']);

$application = $storage->getApplication($applicationId);
$user = $storage->getCurrentUser();

$user->setLastLocation($application->address->latlng);
$user->appsCount = $storage->saveApplication($application); // this also sets app number
$storage->saveUser($user);

$application->setStatus("confirmed");
$application->stopAgresji = $user->stopAgresji();
$edited = $application->hasNumber();

if($edited) {
    $application->address->mapImage = null;
}

$storage->updateRecydywa($application->carInfo->plateId);
$storage->getUserStats(false); // update cache

echo generate('dziekujemy.html.twig', 
    [
        'head' =>
        [
            'title' => "Dziękujemy",
            'shortTitle' => "Dziękujemy",
            'mainClass' => 'dziekujemy'
        ],
        'config' =>
        [
            'auth' => true
        ],
        'app' => $application,
        'appsCount' => $user->appsCount,
        'edited' => $edited,
        'autoSend' => $user->autoSend() && $application->automatedSM()
    ]
);

?>
