<?PHP
require_once __DIR__ . '/../inc/include.php';

if (!isset($_SESSION['newAppId']) || !isset($_POST['applicationId'])) {
    redirect('moje-zgloszenia.html');
}

$applicationId = $_POST['applicationId'];
unset($_SESSION['newAppId']);

$application = $storage->getApplication($applicationId);
$application->setStatus("confirmed");

if(isset($application->number)){ // edit done by admin, number already set
    $storage->saveApplication($application);
    redirect("ud-$applicationId.html");
}

$user = $storage->getCurrentUser();
$user->addApplication($application);
$application->number = 'UD/' . $user->number . '/' . sizeof($user->applications);
$storage->saveApplication($application);
$storage->saveUser($user);
$storage->updateRecydywa($application->carInfo->plateId);

$storage->getUserStats(false); // update cache

echo generate('dziekujemy.html.twig', 
    [
        'head' =>
        [
            'title' => "Dziękujemy",
            'shortTitle' => "Dziękujemy",
            'mainClass' => 'dziekujemy'
        ],
        'config' =>
        [
            'auth' => true
        ],
        'app' => $application,
        'appsCount' => sizeof($user->applications)
    ]
);

?>
