<?PHP
require_once __DIR__ . '/../inc/include.php';

if (!isset($_SESSION['newAppId']) || !isset($_POST['applicationId'])) {
    redirect('moje-zgloszenia.html');
}

$applicationId = $_POST['applicationId'];
unset($_SESSION['newAppId']);
$application = $storage->getApplication($applicationId);
$user = $storage->getCurrentUser();

$edited = $application->hasNumber();

$application->setStatus("confirmed");
$application = $storage->saveApplication($application); // this also sets app number

$user->setLastLocation($application->getLatLng());
$user->appsCount = $application->seq;
$storage->saveUser($user);

$storage->updateRecydywa($application->carInfo->plateId);
$storage->getUserStats(false, $user); // update cache

if($edited) {
    $application->address->mapImage = null;
}


echo generate('dziekujemy.html.twig', 
    [
        'head' =>
        [
            'title' => "Dziękujemy",
            'shortTitle' => "Dziękujemy",
            'mainClass' => 'dziekujemy'
        ],
        'config' =>
        [
            'auth' => true
        ],
        'app' => $application,
        'appsCount' => $user->appsCount,
        'edited' => $edited,
        'autoSend' => $user->autoSend() && $application->automatedSM()
    ]
);

?>
