<?PHP
require_once __DIR__ . '/../inc/include.php';

if (!isset($_SESSION['newAppId']) || !isset($_POST['applicationId'])) {
    redirect('moje-zgloszenia.html');
}

$applicationId = $_POST['applicationId'];
unset($_SESSION['newAppId']);

$application = $storage->getApplication($applicationId);
$application->setStatus("confirmed");

$edited = true;
$user = $storage->getCurrentUser();
if(!$application->hasNumber()){ // new application
    $user->setLastLocation($application->address->latlng);
    $application->stopAgresji = $application->stopAgresji();
    $storage->saveUser($user);
    $edited = false;
}else{
    $application->address->mapImage = null;
}

$lastAppNumer = $storage->saveApplication($application);
$storage->updateRecydywa($application->carInfo->plateId);
$storage->getUserStats(false); // update cache

echo generate('dziekujemy.html.twig', 
    [
        'head' =>
        [
            'title' => "Dziękujemy",
            'shortTitle' => "Dziękujemy",
            'mainClass' => 'dziekujemy'
        ],
        'config' =>
        [
            'auth' => true
        ],
        'app' => $application,
        'appsCount' => $lastAppNumer,
        'edited' => $edited,
        'autoSend' => $user->autoSend() && $application->automatedSM()
    ]
);

?>
