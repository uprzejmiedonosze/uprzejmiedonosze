<?php
require_once(__DIR__ . '/autoload.php');
date_default_timezone_set('Europe/Warsaw');

//$image_bytes = base64_encode(file_get_contents('testy/960x960/ZPL44338.jpg'));
$image_bytes = explode( ',', $_POST['image_data'])[1]; 
//$pictureType = 'carImage';
$pictureType = $_POST['pictureType'];
//$applicationId = '123';
$applicationId = $_POST['applicationId'];

$applicationFile = "app/$applicationId.json";
$application = Array();

if(file_exists($applicationFile)){
	$application = json_decode(file_get_contents($applicationFile));
}else{
	file_put_contents($applicationFile, json_encode($application, JSON_PRETTY_PRINT));
}

$prefix = save_file($image_bytes);

if($pictureType == 'carImage'){ // car picture
	$result = get_car_info($image_bytes);
	if(isset($result) && $result["results"][0]["plate"]){
		$coordinates = $result["results"][0]["coordinates"];
		$xes = Array();
		$yes = Array();
		foreach($coordinates as $ley => $ojb){
			$xes[] = $ojb->getX();
			$yes[] = $ojb->getY();
		}
		$im = imagecreatefromjpeg(make_filename($prefix));
		$plateImage = imagecrop($im, ['x' => min($xes), 'y' => min($yes), 'width' => (max($xes) - min($xes)), 'height' => (max($yes) - min($yes))]);
		if ($plateImage !== FALSE) {
		
			imagejpeg($plateImage, make_filename($prefix, ',p'));
		}
		$output = Array(
			"carInfo" => Array(
				"plateId" => $result["results"][0]["plate"],
				"brand" => $result["results"][0]["vehicle"]['make'][0]['name'],
				"plateImage" => make_filename($prefix, ',p'),
			),
			"carImage" => Array(
				"url" => make_filename($prefix),
				"thumb" => make_filename($prefix, ',t')
			)
		);
	}else{
		$output = Array(
			"carImage" => Array(
				"url" => make_filename($prefix),
				"thumb" => make_filename($prefix, ',t')
			)
		);
	}
}else{ // context picture
	$geo = get_image_location(make_filename($prefix));
	$output = Array(
		"address" => $geo,
		"contextImage" => Array(
			"url" => make_filename($prefix),
			"thumb" => make_filename($prefix, ',t')
			)
		);
}



//print_r($application);
$application = (array) array_merge((array)$application, (array)$output);
$application['id'] = $applicationId;
$application['status'] = 'draft';
$application['date'] = gmDate("Y-m-d\TH:i:s\Z");

file_put_contents($applicationFile, json_encode($application, JSON_PRETTY_PRINT));

echo json_encode($output);

function get_image_location($image){
    $exif = exif_read_data($image, 0, true);
    if($exif && isset($exif['GPS'])){
        $GPSLatitudeRef = $exif['GPS']['GPSLatitudeRef'];
        $GPSLatitude    = $exif['GPS']['GPSLatitude'];
        $GPSLongitudeRef= $exif['GPS']['GPSLongitudeRef'];
        $GPSLongitude   = $exif['GPS']['GPSLongitude'];
        
        $lat_degrees = count($GPSLatitude) > 0 ? gps2Num($GPSLatitude[0]) : 0;
        $lat_minutes = count($GPSLatitude) > 1 ? gps2Num($GPSLatitude[1]) : 0;
        $lat_seconds = count($GPSLatitude) > 2 ? gps2Num($GPSLatitude[2]) : 0;
        
        $lon_degrees = count($GPSLongitude) > 0 ? gps2Num($GPSLongitude[0]) : 0;
        $lon_minutes = count($GPSLongitude) > 1 ? gps2Num($GPSLongitude[1]) : 0;
        $lon_seconds = count($GPSLongitude) > 2 ? gps2Num($GPSLongitude[2]) : 0;
        
        $lat_direction = ($GPSLatitudeRef == 'W' or $GPSLatitudeRef == 'S') ? -1 : 1;
        $lon_direction = ($GPSLongitudeRef == 'W' or $GPSLongitudeRef == 'S') ? -1 : 1;
        
        $latitude = $lat_direction * ($lat_degrees + ($lat_minutes / 60) + ($lat_seconds / (60*60)));
        $longitude = $lon_direction * ($lon_degrees + ($lon_minutes / 60) + ($lon_seconds / (60*60)));

        return array('lat'=>$latitude, 'lng'=>$longitude);
    }else{
        return false;
    }
}

function gps2Num($coordPart){
    $parts = explode('/', $coordPart);
    if(count($parts) <= 0)
    return 0;
    if(count($parts) == 1)
    return $parts[0];
    return floatval($parts[0]) / floatval($parts[1]);
}


function save_file($image_bytes){
	$prefix = "cdn/" . uniqid();

	$ifp = fopen(make_filename($prefix), 'wb'); 
	fwrite($ifp, base64_decode($image_bytes));
	fclose($ifp); 
	
	imagejpeg(resize_image(make_filename($prefix), 350, 350, false), make_filename($prefix, ',t'));

	return $prefix;
}

function make_filename($prefix, $suffix = ''){
	return "$prefix$suffix.jpg";
}

function get_car_info($image_bytes){
	$api_instance = new Swagger\Client\Api\DefaultApi();
	$secret_key = "sk_aa0b80a70b2ae2268b36734a"; 
	$country = "eu"; 
	$recognize_vehicle = 1;
	$state = ""; 
	$return_image = 0; 
	$topn = 1; 
	$prewarp = ""; 

	try {
		return $api_instance->recognizeBytes($image_bytes, $secret_key, $country, $recognize_vehicle, $state, $return_image, $topn, $prewarp);
	} catch (Exception $e) {
		echo 'Exception when calling DefaultApi->recognizeBytes: ', $e->getMessage(), PHP_EOL;
		return null;
	}
}

function resize_image($file, $w, $h, $crop=FALSE) {
	list($width, $height) = getimagesize($file);
	$r = $width / $height;
	if ($crop) {
		if ($width > $height) {
			$width = ceil($width-($width*abs($r-$w/$h)));
		} else {
			$height = ceil($height-($height*abs($r-$w/$h)));
		}
		$newwidth = $w;
		$newheight = $h;
	} else {
		if ($w/$h > $r) {
			$newwidth = $h*$r;
			$newheight = $h;
		} else {
			$newheight = $w/$r;
			$newwidth = $w;
		}
	}
	$src = imagecreatefromjpeg($file);
	$dst = imagecreatetruecolor($newwidth, $newheight);
	imagecopyresampled($dst, $src, 0, 0, 0, 0, $newwidth, $newheight, $width, $height);

	return $dst;
}