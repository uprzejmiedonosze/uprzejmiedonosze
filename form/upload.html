<?php
date_default_timezone_set('Europe/Warsaw');

require_once(__DIR__ . '/../autoload.php');
require_once(__DIR__ . '/../inc/include.php');

//$image_bytes = base64_encode(file_get_contents('testy/960x960/ZPL44338.jpg'));
//$image_bytes = base64_encode(file_get_contents('testy/oneplus5t.jpg'));
$image_bytes = explode( ',', $_POST['image_data'])[1]; 
//$pictureType = 'contextImage';
$pictureType = $_POST['pictureType'];
//$applicationId = '123';
$applicationId = $_POST['applicationId'];

$application = getApplication($applicationId);

$prefix = save_file($image_bytes);

if($pictureType == 'carImage'){ // car picture
	$result = get_car_info($image_bytes);
	if(isset($result) && count($result["results"]) && $result["results"][0]["plate"]){
		$coordinates = $result["results"][0]["coordinates"];
		$xes = Array();
		$yes = Array();
		foreach($coordinates as $ley => $ojb){
			$xes[] = $ojb->getX();
			$yes[] = $ojb->getY();
		}
		$im = imagecreatefromjpeg(make_filename($prefix));
		$plateImage = imagecrop($im, ['x' => min($xes), 'y' => min($yes), 'width' => (max($xes) - min($xes)), 'height' => (max($yes) - min($yes))]);
		if ($plateImage !== FALSE) {
			imagejpeg($plateImage, make_filename($prefix, ',p'));
		}
		$output = Array(
			"carInfo" => Array(
				"plateId" => $result["results"][0]["plate"],
				"brand" => $result["results"][0]["vehicle"]['make'][0]['name'],
				"plateImage" => make_filename($prefix, ',p'),
			),
			"carImage" => Array(
				"url" => make_filename($prefix),
				"thumb" => make_filename($prefix, ',t')
			)
		);
	}else{
		$output = Array(
			"carImage" => Array(
				"url" => make_filename($prefix),
				"thumb" => make_filename($prefix, ',t')
			)
		);
	}
}else{ // context picture
	$output = Array(
		"date" => get_image_date(make_filename($prefix)),
		"contextImage" => Array(
			"url" => make_filename($prefix),
			"thumb" => make_filename($prefix, ',t')
			)
		);
}

$application = (array) array_merge((array)$application, (array)$output);
$application['id'] = $applicationId;
$application['status'] = 'draft';

setApplication($applicationId, $application);

echo json_encode($output);

function get_image_date($image){
	try{
		$exif = @exif_read_data($image, 0, true);
	}catch(Exception $e){
		$exif = false;
	}

	$date = date("Y-m-d\TH:i:s");

	if($exif && isset($exif['EXIF']) && isset($exif['EXIF']['DateTimeOriginal'])){
		$date = date_format(date_create($exif['EXIF']['DateTimeOriginal']), 'Y-m-d\TH:i:s'); // @TODO poprawić na prawidłowy format
	}
	return $date;
}

function gps2Num($coordPart){
    $parts = explode('/', $coordPart);
    if(count($parts) <= 0)
    return 0;
    if(count($parts) == 1)
    return $parts[0];
    return floatval($parts[0]) / floatval($parts[1]);
}


function save_file($image_bytes){
	$prefix = "cdn/" . guidv4();

	$ifp = fopen(make_filename($prefix), 'wb'); 
	fwrite($ifp, base64_decode($image_bytes));
	fclose($ifp); 
	
	imagejpeg(resize_image(make_filename($prefix), 350, 350, false), make_filename($prefix, ',t'));

	return $prefix;
}

function make_filename($prefix, $suffix = ''){
	return "$prefix$suffix.jpg";
}

function get_car_info($image_bytes){
	$api_instance = new Swagger\Client\Api\DefaultApi();
	$secret_key = "sk_aa0b80a70b2ae2268b36734a"; 
	$country = "eu"; 
	$recognize_vehicle = 1;
	$state = ""; 
	$return_image = 0; 
	$topn = 1; 
	$prewarp = ""; 

	try {
		return $api_instance->recognizeBytes($image_bytes, $secret_key, $country, $recognize_vehicle, $state, $return_image, $topn, $prewarp);
	} catch (Exception $e) {
		echo 'Exception when calling DefaultApi->recognizeBytes: ', $e->getMessage(), PHP_EOL;
		return null;
	}
}

function resize_image($file, $w, $h, $crop=FALSE) {
	list($width, $height) = getimagesize($file);
	$r = $width / $height;
	if ($crop) {
		if ($width > $height) {
			$width = ceil($width-($width*abs($r-$w/$h)));
		} else {
			$height = ceil($height-($height*abs($r-$w/$h)));
		}
		$newwidth = $w;
		$newheight = $h;
	} else {
		if ($w/$h > $r) {
			$newwidth = $h*$r;
			$newheight = $h;
		} else {
			$newheight = $w/$r;
			$newwidth = $w;
		}
	}
	$src = imagecreatefromjpeg($file);
	$dst = imagecreatetruecolor($newwidth, $newheight);
	imagecopyresampled($dst, $src, 0, 0, 0, 0, $newwidth, $newheight, $width, $height);

	return $dst;
}