$(document).on("pageshow",function(){if($("#address").length){$("#address").on("change",function(){$("#address").removeClass("error")});$("#plateId").on("change",function(){$("#plateId").removeClass("error")})}if($("#contextImage").length){if(window.File&&window.FileReader&&window.FormData){$(document).on("change","#contextImage",function(a){checkFile(a.target.files[0],this.id)});$(document).on("change","#carImage",function(a){checkFile(a.target.files[0],this.id)})}$("#plateImage").hide()}if($("#form-submit").length){$("#form-submit").click(function(){if(validateForm()){$("#form").submit()}})}});function validateForm(){var a=check($("#plateId"),6,false);a=check($("#address"),10,false)&&a;a=check($("#carImage"),0,true)&&a;a=check($("#contextImage"),0,true)&&a;a=check($("#name"),5,false)&&a;a=check($("#email"),5,false)&&a;if(!a){$(window).scrollTop($(".error").offset().top-100)}return a}function check(b,a,c){if(b.val().trim().length<=a){if(c){b.parent().parent().addClass("error")}else{b.addClass("error")}return false}else{return true}}function setAddress(a){$("a#geo").buttonMarkup({icon:"clock"});$("#address").val("");$("#address").attr("placeholder","(pobieram adres ze zdjęcia...)");$.get("https://maps.googleapis.com/maps/api/geocode/json?latlng="+a+"&key=AIzaSyAsVCGVrc7Zph5Ka3Gh2SGUqDrwCd8C3DU&language=pl&result_type=street_address",function(b){if(b.results){formatted_address=b.results[0].formatted_address.replace(", Polska","");voivodeship=b.results[0].address_components.filter(function(c){return c.types.indexOf("administrative_area_level_1")==0})[0].long_name.replace("Województwo ","");country=b.results[0].address_components.filter(function(c){return c.types.indexOf("country")==0})[0].long_name;city=b.results[0].address_components.filter(function(c){return c.types.indexOf("locality")==0})[0].long_name;$("#address").val(formatted_address);$("#voivodeship").val(voivodeship);$("#country").val(country);$("#city").val(city);$("#latlng").val(a);$("a#geo").buttonMarkup({icon:"check"})}else{$("#voivodeship").val("");$("#country").val("");$("#city").val("");$("#latlng").val("");$("a#geo").buttonMarkup({icon:"alert"})}}).fail(function(){$("a#geo").buttonMarkup({icon:"alert"});$("#latlng").val("")})}function checkFile(a,b){if(b=="contextImage"){EXIF.getData(a,function(){var d=EXIF.getTag(this,"GPSLatitude");var f=EXIF.getTag(this,"GPSLongitude");var e=EXIF.getTag(this,"GPSLatitudeRef")||"N";var c=EXIF.getTag(this,"GPSLongitudeRef")||"W";d=(d[0]+d[1]/60+d[2]/3600)*(e=="N"?1:-1);f=(f[0]+f[1]/60+f[2]/3600)*(c=="W"?-1:1);setAddress(d+","+f)})}$("#"+b).parent().parent().removeClass("error");$("img#"+b+"-img").attr("src","img/loading.gif");if(b=="carImage"){$("#plateImage").attr("src","");$("#plateImage").hide()}if(a){if(/^image\//i.test(a.type)){readFile(a,b)}else{$("#"+b).textinput("enable");$("img#"+b+"-img").attr("src","img/camera.png")}}}function readFile(b,c){var a=new FileReader();a.onloadend=function(){processFile(a.result,b.type,c)};a.onerror=function(){$("#"+c).textinput("enable");$("img#"+c+"-img").attr("src","img/camera.png")};a.readAsDataURL(b)}function processFile(e,a,f){var c=1200,b=1200,d=new Image();d.src=e;d.onload=function(){var k=d.width,g=d.height;var m=(k>c)||(g>b);if(!m){sendFile(e,f);return}var l,h;if(k>g){h=g*(c/k);l=c}else{l=k*(b/g);h=b}var i=document.createElement("canvas");i.width=l;i.height=h;var j=i.getContext("2d");j.drawImage(this,0,0,l,h);e=i.toDataURL(a);sendFile(e,f)};d.onerror=function(){$("img#"+f+"-img").attr("src","img/camera.png");$("#"+f).textinput("enable")}}function sendFile(a,c){var b=new FormData();b.append("image_data",a);b.append("pictureType",c);b.append("applicationId",$("#applicationId").val());$.ajax({type:"POST",url:"/upload.html",data:b,contentType:false,processData:false,success:function(d){json=$.parseJSON(d);if(json.carImage){$("img#"+c+"-img").attr("src",json.carImage.thumb);$("#"+c).textinput("disable")}if(json.contextImage){$("img#"+c+"-img").attr("src",json.contextImage.thumb);$("#"+c).textinput("disable")}if(c=="carImage"&&json.carInfo){if(json.carInfo.plateId){$("#plateId").val(json.carInfo.plateId)}if(json.carInfo.plateImage){$("#plateImage").attr("src",json.carInfo.plateImage);$("#plateImage").show()}}},error:function(d){$("img#"+c+"-img").attr("src","img/camera.png");$("#"+c).textinput("enable")}})};