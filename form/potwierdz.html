<? 
date_default_timezone_set('Europe/Warsaw');

require_once(__DIR__ . '/../autoload.php');
require_once(__DIR__ . '/../inc/include.php');

genHeader("Uprzejmie Donoszę – potwierdź", true);
$post = $_POST;
$applicationId = $post["applicationId"];

$application = getApplication($applicationId);

$address = $post["address"];
$latlng = $post["latlng"];
$voivodeship = $post["voivodeship"];
$country = $post["country"];
$city = $post["city"];

$plateId = strtoupper(trim($post["plateId"]));
$category = $post["category"];

$user = getCurrentUser()['data'];

$comment = capitalizeSentence($post["comment"]);

$app_date = date_format(new DateTime($application->date), 'Y-m-d');
$app_hour = date_format(new DateTime($application->date), 'H:i');
$carImage = $application->carImage->thumb;
$contextImage = $application->contextImage->thumb;

$json = Array(
	"user" => Array(
		"name" => $user['name'],
		"email" => $user['email'],
		"msisdn" => $user['msisdn'],
		"address" => $user['address']
	),
	"category" => $category,
	"address" => Array(
		"address" => $address,
		"city" => $city,
		"voivodeship" => $voivodeship,
		"latlng" => $latlng
	),
	"carInfo" => Array(
		"plateId" => $plateId
	),
	"userComment" => $comment,
	"status" => "ready"
);

$application = (array) array_merge((array)$application, (array)$json);

setApplication($applicationId, $application);

?>
<body class="index">
	<div data-role="page" class="container-fluid" data-theme="a">
		<div data-role="header" data-position="fixed" data-tap-toggle="false">
			<a href="javascript:history.back()" data-rel="back" class="ui-btn-left  ui-alt-icon ui-nodisc-icon ui-btn ui-corner-all ui-icon-edit ui-btn-icon-notext" data-role="button" role="button">Back</a>
			<h1>Potwierdź dane</h1>
			<a onclick="$('#form').submit();"                   class="ui-btn-right ui-alt-icon ui-nodisc-icon ui-btn ui-corner-all ui-btn-inline ui-btn-icon-left ui-icon-check">Potwierdź!</a>
		</div>
		  
		<div data-role="main" class="ui-content">
			<h1>Jeszcze chwila!</h1>
			<p>Wysyłając zgłoszenie wyrażasz gotowość do poświadczenia faktu bycia
			świadkiem wykroczenia które zgłaszasz oraz wyrażasz gotowość
			potwierdzenia tego w Straży Miejskiej.</p>
			<br>

<?
echo <<<HTML
			<div class="ui-body ui-body-a ui-corner-all">
				<h3>Zgłoszenie wykroczenia</h3>
				<p>W dniu <b>$app_date</b> roku o godzinie <b>$app_hour</b> byłem/am świadkiem pozostawienia
					samochodu o nr rejestracyjnym <b>$plateId</b> pod adresem <b>$address</b>.
					{$categories_txt[$category]} Sytuacja jest widoczna na załączonych zdjęciach.</p>
				<p>Nie byłem świadkiem samego momentu parkowania oraz nie wiem jak długo
					pozostawał pojazd pozostawał na tym miejscu.</p>
				<p>$comment</p>
				<p>Dane adresowe oraz kontaktowe zgłaszającego:<br /><br />
					{$user['name']}<br />
					{$user['email']}<br />
					{$user['address']}<br />
					{$user['msisdn']}
				</p>
				<div id="#pics" class="ui-grid-a ui-responsive">
					<div class="ui-block-a">
						<img src="{$contextImage}"> 
					</div>
					<div class="ui-block-b">
						<img src="{$carImage}">
					</div>
				</div>
			</div>
HTML;
?>
			<form action="/dziekujemy.html" id="form" method="post" data-ajax="true">
				<input type="hidden" id="applicationId" name="applicationId" value="<?=$applicationId ?>"/>
			</form>
		</div> <!-- main -->
<? getFooter() ?>
