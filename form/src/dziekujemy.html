<?PHP
require_once __DIR__ . '/../inc/include.php';

if (!isset($_SESSION['newAppId']) || !isset($_POST['applicationId'])) {
    redirect('moje-zgloszenia.html');
}

$applicationId = $_POST['applicationId'];
unset($_SESSION['newAppId']);

$application = $storage->getApplication($applicationId);
$user = $storage->getCurrentUser();

$user->addApplication($application);
$application->setStatus("confirmed");
$application->number = 'UD/' . $user->number . '/' . sizeof($user->applications);

$storage->saveApplication($application);
$storage->saveUser($user);
$storage->updateRecydywa($application->carInfo->plateId);

generate('dziekujemy.html.twig', 
    [
        'head' =>
        [
            'title' => "Dziękujemy",
            'shortTitle' => "Dziękujemy"
        ],
        'config' =>
        [
            'auth' => true
        ],
        'app' => $application,
        'appsCount' => sizeof($user->applications)
    ]
);

_sendSlackUpdate("Nowe zgłoszenie `{$application->number}`"
    . " od *{$application->user->name}*"
    . " ({$application->address->city}): "
    . "https://%HOST%/ud-{$application->id}.html");

?>
