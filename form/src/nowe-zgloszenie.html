<?PHP
require_once(__DIR__ . '/../inc/include.php');
genHeader("Uprzejmie Donoszę – nowe zgłoszenie", true);

if(isset($_SESSION['newAppId'])){ // edit mode
	$applicationId = $_SESSION['newAppId'];
	try{
        $application = getApplication($applicationId);
    }catch(Exception $e){
        $application = null;
    }
	$edit = isset($application) && $application->status == 'ready'; // page refresh probably (edit mode, but application is empty)
}else{ // new application mode
	$applicationId = guidv4();
	$_SESSION['newAppId'] = $applicationId;
	$edit = false;
}

$contextImage = ($edit)? $application->contextImage->thumb: 'img/camera.png';
$carImage     = ($edit)? $application->carImage->thumb: 'img/camera.png';

$address      = ($edit)? $application->address->address: '';
$latlng       = ($edit)? $application->address->latlng: '';
$voivodeship  = ($edit)? $application->address->voivodeship: '';
$city         = ($edit)? $application->address->city: '';

$plateId      = ($edit)? $application->carInfo->plateId: '';
$category     = ($edit)? $application->category: 7;
@$comment     = ($edit)? $application->userComment: '';

$date         = ($edit)? $application->date: '';

?>
	<body class="index new-application">
		<div data-role="page" class="container-fluid" data-theme="a">
			<div data-role="header" data-position="fixed" data-tap-toggle="false" data-hide-during-focus="false">
				<? menuBack(); ?>
				<h1>Nowe zgłoszenie</h1>
				<a id="form-submit" class="ui-btn-right ui-alt-icon ui-nodisc-icon ui-btn ui-corner-all ui-btn-inline ui-btn-icon-left ui-icon-action">Zgłoś</a>
			</div>
			<div data-role="main" class="ui-content">
				<form action="/potwierdz.html" id="form" method="post" data-ajax="false">
					<input type="hidden" name="applicationId" id="applicationId" value="<?=$applicationId ?>"/>
					<div>
						<label class="section">Dane zgłoszenia</label>
						<div class="ui-grid-a ui-responsive" id="pics">
							<div class="ui-block-a">
								<div class="image-upload">
									<label for="contextImage">
										Zrób zdjęcie prezentujące kontekst zgłoszenia<br>
										<img class="photo-thumbs" id="contextImage-img" src="<?=$contextImage;?>"/>
									</label>
									<input type="file" accept="image/jpeg" id="contextImage" title="Zdjęcie przedstawiające kontekst" value="<?=($edit)? $application->contextImage->url: '';?>" />
								</div>
							</div>
							<div class="ui-block-b">
								<div class="image-upload">
									<label for="carImage">
										Zrób zdjęcie na którym widoczna jest tablica rejestracyjna<br>
										<img class="photo-thumbs" id="carImage-img" src="<?=$carImage?>"/><br/>
										<img id="plateImage" src=""/><br/>
										<span id="recydywa"></span>
									</label>
									<input type="file" accept="image/jpeg" id="carImage" title="Zdjęcie przedstawiające samochód tablice rejestracyjne" value="<?=($edit)?$application->carImage->url: '';?>" />
								</div>
							</div>
						</div>

						<input type="hidden" id="datetime" name="datetime" value="<?=$date?>" />

						<label for="address">Podaj miejsce zgłoszenia <a href="#" id="geocomplete">(pobierz adres)</a></label>
						<div class="combo">
							<input type="text" maxlength="70" required id="address" name="address" placeholder="Miejsce zgłoszenia" data-inline="true" value="<?=$address?>">
							<a id="geo" data-role="button" data-icon="location" data-iconpos="notext" data-mini="true" data-inline="true" data-corners="true" data-shadow="false" data-iconshadow="false" data-wrapperels="span" data-theme="b" title="GPS"></a>
						</div>

						<input type="hidden" id="street_number" name="street_number" />
						<input type="hidden" id="route" name="street_name" />
						<input type="hidden" id="locality" name="city" value="<?=$city?>" />
						<input type="hidden" id="administrative_area_level_1" name="voivodeship" value="<?=$voivodeship?>" />
						<input type="hidden" id="country" name="country" />
						<input type="hidden" id="latlng" name="latlng" value="<?=$latlng?>" />

						<label for="plateId">Podaj numer rejestracyjny pojazdu który dokonał naruszenia</label>
						<input class="required" type="text" id="plateId" name="plateId" placeholder="Numer rejestracyjny" value="<?=$plateId?>" />

						<label for="comment">Dodaj komentarz (wymagany dla kategorii "pozostałe")</label>
						<textarea type="text" id="comment" name="comment"
							placeholder="Np. szczegóły dotyczące lokalizacji"><?=$comment?></textarea>

						<label for="category" class="section">Podaj rodzaj naruszenia</label>

						<div class="ui-grid-a ui-responsive" id="category">
							<? 
								$i = 0;
								foreach(CATEGORIES as $catId => $catName):
									if(!isset($catName[0])){
										continue;
									}

							?>
							<div class="ui-block-<? echo(CATEGORIES_MATRIX[$i % 2]); ?>" title="<?=strip_tags($catName[2])?>">
								<input type="radio" name="category" value="<?=$catId ?>" id="<?=$catId ?>" <? echo ($catId == $category)?' checked="checked" ': '';?>>
								<label for="<?=$catId ?>">
									<img src="img/<?=$catId ?>.jpg">
									<p><?=$catName[0];?></p>
								</label>
							</div>
							<?
								$i++;
								endforeach;
							?>
							<p>Masz wątpliwości którą kategorię wybrać? Przeczytaj <a href="przepisy.html?dialog" close-btn="none" data-transition="pop">nasz poradnik</a>.</p>
						</div>
						

					</div> <!-- ui-field-contain -->
				</form>
			</div> <!-- main -->
			<script src="js/exif-%JS_HASH%.js"></script>
<? getFooter('initAutocompleteOnNewApplication') ?>
