<? 
require_once(__DIR__ . '/../autoload.php');
require_once(__DIR__ . '/../inc/include.php');

genHeader("Uprzejmie Donoszę – potwierdź", true);
$post = $_POST;
$applicationId = $post["applicationId"];

$application = getApplication($applicationId);

$address = $post["address"];
$latlng = $post["latlng"];
$voivodeship = $post["voivodeship"];
$country = $post["country"];
$city = $post["city"];

$plateId = strtoupper(trim($post["plateId"]));
$category = $post["category"];
$comment = capitalizeSentence($post["comment"]);

$date = date_format(new DateTime($post['datetime']), 'Y-m-d\TH:i:s');
$app_date = date_format(new DateTime($date), 'Y-m-d');
$app_hour = date_format(new DateTime($date), 'H:i');
$carImage = $application->carImage->thumb;
$contextImage = $application->contextImage->thumb;
@$plateImage = $application->carInfo->plateImage;

$user = getCurrentUser()['data'];

$json = Array(
	"date" => $date,
	"user" => Array(
		"name" => $user['name'],
		"email" => $user['email'],
		"msisdn" => $user['msisdn'],
		"address" => $user['address']
	),
	"category" => $category,
	"address" => Array(
		"address" => $address,
		"city" => $city,
		"voivodeship" => $voivodeship,
		"latlng" => $latlng
	),
	"carInfo" => Array(
		"plateId" => $plateId,
		"plateImage" => $plateImage
	),
	"userComment" => $comment,
	"status" => "ready"
);

$application = (array) array_merge((array)$application, (array)$json);
$sex      = guess_sex_by_name($user['name']);
$bylam    = $sex['bylam'];
$swiadoma = $sex['swiadoma'];
$wykonalam = $sex['wykonalam'];
setApplication($applicationId, $application);

?>
<body class="index">
	<div data-role="page" class="container-fluid" data-theme="a">
		<div data-role="header" data-position="fixed" data-tap-toggle="false">
			<? menuBack('Back', 'ui-icon-edit'); ?> 
			<h1>Potwierdź dane</h1>
			<a onclick="$('#form').submit();" class="ui-btn-right ui-alt-icon ui-nodisc-icon ui-btn ui-corner-all ui-btn-inline ui-btn-icon-left ui-icon-check">Potwierdź!</a>
		</div>
		  
		<div data-role="main" class="ui-content">
			<h1>Jeszcze chwila!</h1>
			<p>Sprawdź dane przed utworzeniem zgłoszenia. Nie obawiaj się – na tym etapie nic jeszcze nie zostanie wysłane do SM.</p>
			<br>

<?
echo <<<HTML
			<div class="ui-body ui-body-a ui-corner-all">
				<h3>Zgłoszenie wykroczenia</h3>
				<p>W dniu <b>$app_date</b> roku o godzinie <b>$app_hour</b> $bylam świadkiem pozostawienia
					samochodu o nr rejestracyjnym <b>$plateId</b> pod adresem <b>$address</b>.
					{$categories[$category][1]} Zdjęcia $wykonalam samodzielnie.</p>
				<p>Nie $bylam świadkiem samego momentu parkowania, oraz nie wiem jak długo
					pozostawał pojazd pozostawał na tym miejscu.</p>
				<p>$comment</p>
				<p>Jestem $swiadoma odpowiedzialności karnej z art. 233 §1–§3 Kodeksu karnego
				 	oraz treści art. 182, 183 i 185 Kodeksu Postępowania Karnego.</p>
				<p>Równocześnie proszę o niezamieszczanie w protokole danych dotyczących
					mojego miejsca zamieszkania.</p>
				<p>Dane adresowe oraz kontaktowe zgłaszającego:<br /><br />
					{$user['name']}<br />
					{$user['email']}<br />
					{$user['address']}<br />
					{$user['msisdn']}
				</p>
				<div id="pics" class="ui-grid-a ui-responsive">
					<div class="ui-block-a">
						<img class="photo-thumbs" src="{$contextImage}"> 
					</div>
					<div class="ui-block-b">
						<img class="photo-thumbs" src="{$carImage}">
					</div>
				</div>
			</div>
HTML;
?>
			<form action="/dziekujemy.html" id="form" method="post" data-ajax="true">
				<input type="hidden" id="applicationId" name="applicationId" value="<?=$applicationId ?>"/>
			</form>
		</div> <!-- main -->
<? getFooter() ?>
