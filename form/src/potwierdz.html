<? 
require_once(__DIR__ . '/../inc/include.php');

$post = $_POST;

if(!isset($post['applicationId'])){
    redirect("nowe-zgloszenie.html");
}

$applicationId = $post["applicationId"];
$application = $storage->getApplication($applicationId);

$application->date = date_format(new DateTime($post['datetime']), DT_FORMAT);
$application->category = intval($post["category"]);
if(!isset($application->address)) $application->address = new stdClass();
$application->address->address = $post["lokalizacja"];
$application->address->city = $post["city"];
$application->guessSMData(); // stores sm city inside the object
$application->address->voivodeship = $post["voivodeship"];
$application->address->latlng = $post["latlng"];
if(!isset($application->carInfo)) $application->carInfo = new stdClass();
$application->carInfo->plateId = strtoupper(trim($post["plateId"]));
$application->userComment = capitalizeSentence($post["comment"]);
$application->initStatements();
$application->statements->witness = !(boolean)$post['witness'];
$application->setStatus("ready");

$storage->saveApplication($application);

generate('potwierdz.html.twig', 
    [
        'head' =>
        [
            'title' => "Potwierdź",
            'shortTitle' => "Potwierdź"
        ],
        'config' =>
        [
            'auth' => true,
            'appDetails' => true,
            'isAppOwnerOrAdmin' => true,
            'confirmationScreen' => true
        ],
        'app' => $application
    ]
);

?>
