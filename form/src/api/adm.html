<?PHP
header("Content-Type: application/json; charset=UTF-8");
require_once(__DIR__ . '/../../inc/include.php');

if(!$storage->getCurrentUser()->isAdmin()){
    logger("User " . getCurrentUserEmail() . " tried to delete account " . $email, true);
    raiseError('Admin only area', 403);
}

if (isset($_GET["action"]) && !empty($_GET["action"])) {
    $action = $_GET["action"];
    logger("adm.html:_ action=$action", true);
    switch($action) {
        case "admin-remove-user":
            _removeUser($_GET['email']); break;
        default: raiseError('Invalid action specified', 400);
    }
}else{
    raiseError('No action specified', 400);
}

function _removeUser($email){
    global $storage;

    if(!isset($email)){
        raiseError('No email provided', 403);
    }

    $email = SQLite3::escapeString($email);

    try{
        $user = $storage->getUser($email);
    }catch(Exception $e){
        raiseError("Trying to remove nonesiting user: $email", 400);
    }

    $stmt = $storage->execute("select "
        . "json_extract(applications.value, '$.id'), "
        . "json_extract(applications.value, '$.status'), "
        . "json_extract(applications.value, '$.carImage.url'), "
        . "json_extract(applications.value, '$.carImage.thumb'), "
        . "json_extract(applications.value, '$.contextImage.url'), "
        . "json_extract(applications.value, '$.contextImage.thumb'), "
        . "json_extract(applications.value, '$.carInfo.plateImage') "
        . "from applications, json_tree(applications.value, '$.user.email') "
        . "where json_tree.value = '$email';");

    $output = Array();
    $output['files'] = Array();
    $output['apps'] = Array();
    $output['user'] = $user->data;

    while ($row = $stmt->fetch(\PDO::FETCH_NUM, \PDO::FETCH_ORI_NEXT)) {
        $row[2] && array_push($output['files'], $row[2]);
        $row[3] && array_push($output['files'], $row[3]);
        $row[4] && array_push($output['files'], $row[4]);
        $row[5] && array_push($output['files'], $row[5]);
        $row[6] && array_push($output['files'], $row[6]);
        @array_push($output['apps'], $row[0]);
    }

    // removing all files
    foreach($output['files'] as $file){
        if($file){
            unlink(__DIR__ . "/../$file");
        }
    }

    // removing apps and PDFs
    foreach($output['apps'] as $appId){
        $storage->removeApplication($appId);
        @unlink(__DIR__ . "/../$appId.pdf");
    }

    // adding empty user under a different key
    $time = date(DT_FORMAT);
    $user->data->name = 'DELETED';
    $user->data->msisdn = 'DELETED';
    $user->data->address = 'DELETED';
    $user->data->email = md5($email . $time);
    $user->data->emailMD5 = md5($email);

    $user->deleted = $time;
    $user->applications = Array();
    $storage->saveUser($user);

    // removing old user
    $storage->removeUser($email);

    echo json_encode($output, JSON_PRETTY_PRINT);
}
?>
