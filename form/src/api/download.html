<?PHP
require(__DIR__ . '/../../inc/include.php');

const ROOT = __DIR__ . "/..";

$type = 'application';                               // download application PDF for specific application
if(isset($_GET['hearing'])) $type = 'hearing';       // download hearing PDF for SM for specific application
if(isset($_GET['hearingAll'])) $type = 'hearingAll'; // download hearing PDFs for SM for all open applications
if(isset($_GET['readyApps'])) $type = 'readyApps';   // download all apps ready to sent

if($type == 'application' || $type == 'hearing'){    // specific ID is needed
    if(!isset($_GET['appId'])){
        http_response_code(400);
        die();
    }
    $applicationId = $_GET['appId'];
    $application = $storage->getApplication($applicationId);
    if(!isset($application)){
        http_response_code(404);
        die();
    }
}else if ($type == 'hearingAll'){
    $appsEmail = $storage->getAllApplicationsByStatus('confirmed-waiting');
    $appsEpuap = $storage->getAllApplicationsByStatus('confirmed-waitingE');
    $application = array_merge($appsEmail, $appsEpuap);
}else{ // readyApps
    $application = $storage->getAllApplicationsByStatus('confirmed');
}

if($type !== 'application'){ // only applicationPDF is allowed if not logged in
    checkIfLogged();
    $user = $storage->getCurrentUser();
}

if($type == 'hearing'){
    $filename = $application->getSMPDFFilename();
    $pdf = ROOT . "/cdn/$applicationId,sm.pdf";
}else if($type == 'application'){
    $filename = $application->getAppPDFFilename();
    $pdf = ROOT . "/cdn/$applicationId.pdf";
}else if($type == 'hearingAll'){
    $filename = 'Dokumenty-' . $user->getSanitizedName() . '-' . date('Y-m-d') . '.pdf';
    $pdf = '/tmp/' . $filename;
}else{ // readyApps
    $filename = 'Zgloszenia-' . $user->getSanitizedName() . '-' . date('Y-m-d') . '.pdf';
    $pdf = '/tmp/' . $filename;
}

//if(!file_exists($pdf)){
    generate_pdf($application, $pdf, $type);
//}

header('Content-Type: application/pdf');
header("Content-Transfer-Encoding: Binary");
header("Content-disposition: attachment; filename=$filename");
readfile($pdf);

function generate_pdf($application, $destFile, $type) {
    if(($f = tempnam(sys_get_temp_dir(), 'tex-')) === false) {
        throw new Exception("Failed to create temporary file");
    }

    $tex_f = "$f.tex";
    $aux_f = "$f.aux";
    $out_f = "$f.out";
    $log_f = "$f.log";
    $pdf_f = "$f.pdf";

    $loader = new Twig_Loader_Filesystem(__DIR__ . '/../../templates');   
    $twig = new Twig_Environment($loader,
    [
        'debug' => false,
        'cache' => new Twig_Cache_Filesystem('/tmp/twig', Twig_Cache_Filesystem::FORCE_BYTECODE_INVALIDATION),
        'strict_variables' => true,
        'auto_reload' => true
    ]);

    $texFile = 'application.tex.twig';
    if($type == 'hearing'){
        $texFile = 'hearing.tex.twig';
    }else if($type == 'hearingAll'){
        $texFile = 'hearingAll.tex.twig';
    }else if($type == 'readyApps'){
        $texFile = 'readyApps.tex.twig';
    }

    $params = [
        'app' => $application,
        'root' => realpath(__DIR__ . '/..')
    ];

    if($type == 'hearing' || $type == 'hearingAll' || $type == 'readyApps'){
        global $user;
        $params['user'] = $user; 
    }
    if(isset($_GET['tomorrow'])){
        $params['date'] = (new DateTime('tomorrow'))->format('d.m.Y');
    }

    file_put_contents($tex_f, $twig->render($texFile, $params));

    $cmd = sprintf("/usr/bin/pdflatex -interaction nonstopmode %s", // -halt-on-error
   	escapeshellarg($tex_f));
    chdir(sys_get_temp_dir());
    exec($cmd, $output, $ret);
    unset($output);

   	@unlink($tex_f);
    @unlink($aux_f);
    @unlink($log_f);
    @unlink($out_f);

    if(!file_exists($pdf_f)) {
        @unlink($f);
        throw new Exception("Output was not generated and latex returned: $ret.");
    }
    
    rename($pdf_f, $destFile);
    @unlink($f);
}



?>
