<?PHP
require(__DIR__ . '/../../inc/include.php');

const ROOT = __DIR__ . "/..";

if(!isset($_GET['appId'])){
    http_response_code(400);
    die();
}

$applicationId = $_GET['appId'];
$application = $storage->getApplication($applicationId);

$smDocs = isset($_GET['smDocs']);

if(!isset($application)){
    http_response_code(404);
    die();
}

if($smDocs){
    $pdf = ROOT . "/cdn/$applicationId,sm.pdf";
    $filename = $application->getSMPDFFilename();
}else{
    $pdf = ROOT . "/cdn/$applicationId.pdf";
    $filename = $application->getAppPDFFilename();
}

//if(!file_exists($pdf)){
    generate_pdf($application, $pdf, $smDocs);
//}

header('Content-Type: application/pdf');
header("Content-Transfer-Encoding: Binary");
header("Content-disposition: attachment; filename=$filename");
readfile($pdf);

function generate_pdf($application, $destFile, $smDocs) {
	if(($f = tempnam(sys_get_temp_dir(), 'tex-')) === false) {
		throw new Exception("Failed to create temporary file");
	}

	$tex_f = "$f.tex";
	$aux_f = "$f.aux";
	$out_f = "$f.out";
	$log_f = "$f.log";
	$pdf_f = "$f.pdf";

    $loader = new Twig_Loader_Filesystem(__DIR__ . '/../../templates');   
    $twig = new Twig_Environment($loader,
    [
        'debug' => false,
        'cache' => new Twig_Cache_Filesystem('/tmp/twig', Twig_Cache_Filesystem::FORCE_BYTECODE_INVALIDATION),
        'strict_variables' => true,
        'auto_reload' => true
    ]);

    $texFile = ($smDocs)? 'przesluchanie.tex.twig': 'application.tex.twig';

    $params = [
        'app' => $application,
        'root' => realpath(__DIR__ . '/..')
    ];

    if($smDocs && isLoggedIn()){
        global $storage;
        $params['user'] = $storage->getCurrentUser(); 
    }

	file_put_contents($tex_f, $twig->render($texFile, $params));

	$cmd = sprintf("/usr/bin/pdflatex -interaction nonstopmode %s", // -halt-on-error
   	escapeshellarg($tex_f));
	chdir(sys_get_temp_dir());
    exec($cmd, $output, $ret);
    unset($output);

   	@unlink($tex_f);
	@unlink($aux_f);
	@unlink($log_f);
	@unlink($out_f);

	if(!file_exists($pdf_f)) {
		@unlink($f);
		throw new Exception("Output was not generated and latex returned: $ret.");
	}
    
	rename($pdf_f, $destFile);
	@unlink($f);
}



?>
