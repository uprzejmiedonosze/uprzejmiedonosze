<?PHP
header("Content-Type: application/json; charset=UTF-8");
require_once(__DIR__ . '/../../inc/include.php');
require(__DIR__ . '/../../autoload.php');

if (is_ajax()) {
    if (isset($_POST["action"]) && !empty($_POST["action"])) {
        $action = $_POST["action"];
        logger("api.html:_ action=$action");
        switch($action) {
            case "verifyToken": _verifyToken(); break;
            case "archived":
            case "confirmed":
            case "confirmed-waiting":
            case "confirmed-waitingE":
            case "confirmed-sm":
            case "confirmed-ignored":
            case "confirmed-fined":
                _action($action, $_POST["id"]); break;
            case "upload":
                _upload(); break;
            default: raiseError('Invalid action specified', 400);
        }
    }else{
        raiseError('No action specified', 400);
    }
}else{
    raiseError('No AJAX request', 403);
}
  
function is_ajax() {
    return isset($_SERVER['HTTP_X_REQUESTED_WITH']) && strtolower($_SERVER['HTTP_X_REQUESTED_WITH']) == 'xmlhttprequest';
}

function _verifyToken(){
    if(isset($_POST['pa']) && !empty($_POST['pa'])){
        if(verifyToken($_POST['pa'])){
            echo json_encode(Array(
                'user_email' => $_SESSION['user_email'],
                'user_name' => $_SESSION['user_name'],
                'user_picture' => $_SESSION['user_picture'],
                'user_id' => $_SESSION['user_id']
            ));
        }else{
            logger('api.html:_verifyToken Token not verified');
            raiseError("Token not verified", 401);
        }
    }else{
        logger('api.html:_verifyToken Token not specified');
        raiseError("Token not specified", 400);
    }
}

function _action($action, $appId){
    global $storage;
    $application = $storage->getApplication($appId);
    $application->setStatus($action);
    $storage->saveApplication($application);
    echo json_encode(Array("status" => "OK"));
}

/**
 * Compares 'plate results' and sorts it by confidence.
 */
function cmp($a, $b){
    if($a['confidence'] > $b['confidence']) return -1;
    if($a['confidence'] < $b['confidence']) return 1;
    return 0;
}

function _upload(){
    global $_POST, $storage;
    $image_bytes = explode( ',', $_POST['image_data'])[1]; 
    $pictureType = $_POST['pictureType'];
    $applicationId = $_POST['applicationId'];

    try{
        $application = $storage->getApplication($applicationId);
    }catch(Exception $e){
        $application = new Application();
        $storage->saveApplication($application);
    }
    $prefix = save_img_and_thumb($image_bytes);

    if($pictureType == 'carImage'){
        $car_info = get_car_info($image_bytes);

        $application->carImage = new stdClass();
        $application->carImage->url = make_image_url($prefix);
        $application->carImage->thumb = make_image_url($prefix, ',t');

        if(isset($car_info) && count($car_info["results"])){
            logger('ALPR (cost: ' . $car_info['credit_cost'] . ', this month: ' . 
                $car_info['credits_monthly_used'] . ', out of: ' .
                $car_info['credits_monthly_total'], true);

            $result = (Array)$car_info['results'];
            usort($result, "cmp");

            $result = $result[0];

            $coordinates = $result["coordinates"];
            $xes = Array();
            $yes = Array();
            foreach($coordinates as $ojb){
                $xes[] = $ojb->getX();
                $yes[] = $ojb->getY();
            }

            $im = imagecreatefromjpeg(make_image_filename($prefix));
            $plateImage = imagecrop($im, ['x' => min($xes), 'y' => min($yes), 'width' => (max($xes) - min($xes)), 'height' => (max($yes) - min($yes))]);
            if ($plateImage !== FALSE) {
                imagejpeg($plateImage, make_image_filename($prefix, ',p'));
            }

            $recydywa = $storage->countApplicationsPerPlate($result["plate"]);

            $application->carInfo = new stdClass();
            $application->carInfo->plateId = strtoupper($result["plate"]);
            $application->carInfo->plateIdFromImage = strtoupper($result["plate"]);
            $application->carInfo->brand = $result["vehicle"]['make'][0]['name'];
            $application->carInfo->plateImage = make_image_url($prefix, ',p');
            $application->carInfo->recydywa = $recydywa;
        }
    }else if($pictureType == 'contextImage'){
        $application->date = date(DT_FORMAT);
        $application->contextImage = new stdClass();
        $application->contextImage->url = make_image_url($prefix);
        $application->contextImage->thumb = make_image_url($prefix, ',t');
        
        if($geo = read_gps_location(make_image_filename($prefix))){
            !$application->address && $application->address = new stdClass();
            $application->address->latlngFromImage = $geo;
        }
    }else{
        raiseError("Uknown picture type: " . $pictureType, 400);
    }

    $storage->saveApplication($application);

    echo json_encode($application);
}

/**
 * https://staging.uprzejmiedonosze.net/cdn/6cab0aa0-3317-478d-97a3-31d278db5861,t.jpg
 * https://%HOST%/cdn/$HASH$THUMB.jpg » __DIR__/../cdn/$HASH$THUMB.jpg
 * https://%HOST%/$prefix$type.jpg » __DIR__/../$prefix$type.jpg
 */

/**
 * Saves byte_stream to `__DIR__/../$prefix.jpg`
 * and it's thumb to    `__DIR__/../$prefix,t.jpg`.
 * 
 * Returns:
 *   $prefix
*/
function save_img_and_thumb($image_bytes){
    $prefix = "cdn/" . guidv4();
    
    $filename  = make_image_filename($prefix);
    $thumbname = make_image_filename($prefix, ',t');

    $ifp = @fopen(make_image_filename($prefix), 'wb');
    if($ifp === false){
        raiseError("Can't open $filename for write", 500);
    }
    
	if(fwrite($ifp, base64_decode($image_bytes)) === false){
        raiseError("Can't write to $filename", 500);
    }
    fclose($ifp);

	if(!imagejpeg(resize_image($filename, 600, 600, false), $thumbname)){
        logger("Wasn't able to write $filename as thumb to $thumbname.", true);
    }

	return $prefix;
}

/**
 * Generates fill filename from given $prefix and $suffix.
 */
function make_image_filename($prefix, $suffix = ''){
	return __DIR__ . "/../$prefix$suffix.jpg";
}

function make_image_url($prefix, $suffix = ''){
    return "$prefix$suffix.jpg";
}

/**
 * Get's car info from image.
 * 
 * Returns:
 *  object
 *  null on error
 */
function get_car_info($image_bytes){
	$api_instance = new Swagger\Client\Api\DefaultApi();
	$secret_key = "sk_aa0b80a70b2ae2268b36734a"; 
	$country = "eu"; 
	$recognize_vehicle = 1;
	$state = ""; 
	$return_image = 0; 
	$topn = 1; 
	$prewarp = ""; 

	try {
		return $api_instance->recognizeBytes($image_bytes, $secret_key, $country, $recognize_vehicle, $state, $return_image, $topn, $prewarp);
	} catch (Exception $e) {
		logger('Exception when calling DefaultApi->recognizeBytes: ' . $e->getMessage(), true);
		return null;
	}
}

/**
 * Resizes given .jpg file data_stream.
 * 
 * Returns:
 *   destination image link resource
 */
function resize_image($file, $w, $h, $crop=FALSE) {
	list($width, $height) = getimagesize($file);
	$r = $width / $height;
	if ($crop) {
		if ($width > $height) {
			$width = ceil($width-($width*abs($r-$w/$h)));
		} else {
			$height = ceil($height-($height*abs($r-$w/$h)));
		}
		$newwidth = $w;
		$newheight = $h;
	} else {
		if ($w/$h > $r) {
			$newwidth = $h*$r;
			$newheight = $h;
		} else {
			$newheight = $w/$r;
			$newwidth = $w;
		}
	}
	$src = imagecreatefromjpeg($file);
	$dst = imagecreatetruecolor($newwidth, $newheight);
	imagecopyresampled($dst, $src, 0, 0, 0, 0, $newwidth, $newheight, $width, $height);

	return $dst;
}

/**
 * Returns an array of latitude and longitude from the Image file
 * @param image $file
 * @return multitype:number |boolean
 */
function read_gps_location($file){
    if (is_file($file)) {
        $info = @exif_read_data($file);
        if (isset($info['GPSLatitude']) && isset($info['GPSLongitude']) &&
            isset($info['GPSLatitudeRef']) && isset($info['GPSLongitudeRef']) &&
            in_array($info['GPSLatitudeRef'], array('E','W','N','S')) && in_array($info['GPSLongitudeRef'], array('E','W','N','S'))) {
            
            logger("read_gps_location: gps data set");

            $GPSLatitudeRef  = strtolower(trim($info['GPSLatitudeRef']));
            $GPSLongitudeRef = strtolower(trim($info['GPSLongitudeRef']));

            $lat_degrees_a = explode('/',$info['GPSLatitude'][0]);
            $lat_minutes_a = explode('/',$info['GPSLatitude'][1]);
            $lat_seconds_a = explode('/',$info['GPSLatitude'][2]);
            $lon_degrees_a = explode('/',$info['GPSLongitude'][0]);
            $lon_minutes_a = explode('/',$info['GPSLongitude'][1]);
            $lon_seconds_a = explode('/',$info['GPSLongitude'][2]);

            $lat_degrees = $lat_degrees_a[0] / $lat_degrees_a[1];
            $lat_minutes = $lat_minutes_a[0] / $lat_minutes_a[1];
            $lat_seconds = $lat_seconds_a[0] / $lat_seconds_a[1];
            $lon_degrees = $lon_degrees_a[0] / $lon_degrees_a[1];
            $lon_minutes = $lon_minutes_a[0] / $lon_minutes_a[1];
            $lon_seconds = $lon_seconds_a[0] / $lon_seconds_a[1];

            $lat = (float) $lat_degrees+((($lat_minutes*60)+($lat_seconds))/3600);
            $lon = (float) $lon_degrees+((($lon_minutes*60)+($lon_seconds))/3600);

            //If the latitude is South, make it negative. 
            //If the longitude is west, make it negative
            $GPSLatitudeRef  == 's' ? $lat *= -1 : '';
            $GPSLongitudeRef == 'w' ? $lon *= -1 : '';

            return "$lat,$lon";
        }           
    }
    return false;
}

?>
