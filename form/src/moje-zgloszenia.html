<? 
require_once(__DIR__ . '/../inc/include.php');

checkIfLogged();

$user = $storage->getCurrentUser();
$applications = $user->getApplicationIds();

$active = [];
$archived = [];

$changeMail = isset($_GET['changeMail']);
$changeEpuap = (!$changeMail) && isset($_GET['changeEpuap']);

$countChanged = 0;

foreach($applications as $id){
    $application = $storage->getApplication($id);
    if($changeMail || $changeEpuap){
        if($application->status == 'confirmed'){
            if($changeMail){
                $application->setStatus('confirmed-waiting');
            }
            if($changeEpuap){
                $application->setStatus('confirmed-waitingE');
            }
            $storage->saveApplication($application);
            $countChanged++;
        }
    }
    if($application->status == 'archived'){
        array_push($archived, $application);
    }else{
        array_push($active, $application);
    }
}

$stats = $storage->countApplicationsStatuses();

generate('moje-zgloszenia.html.twig', 
    [
        'head' =>
        [
            'title' => "Moje zgłoszenia",
            'shortTitle' => "Moje zgłoszenia"
        ],
        'config' =>
        [
            'auth' => true,
            'appDetails' => false,
            'appActionButtons' => true
        ],
        'active' => $active,
        'archived' => $archived,
        'stats' => $stats,
        'statuses' => STATUSES,
        'countChanged' => $countChanged
    ]
);
?>
