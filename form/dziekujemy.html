<? 
date_default_timezone_set('Europe/Warsaw');

require_once(__DIR__ . '/autoload.php');
require_once(__DIR__ . '/inc/include.php');

require_once('Mail.php');
require_once('Mail/mime.php');

genHeader();

$applicationId = $_POST['applicationId'];

$application = getApplication($applicationId);

$app_date = date_format(new DateTime($application->date), 'Y-m-d');
$app_hour = date_format(new DateTime($application->date), 'H:i');
$app_plateId = $application->carInfo->plateId;
$app_address = $application->address->address;
$carImage = $application->carImage->thumb;
$contextImage = $application->contextImage->thumb;
$category = $categories_txt[$application->category];
$name = $application->user->name;
$msisdn = $application->user->msisdn;
$email = $application->user->email;
$comment = $application->comment;

$user = saveUserApplication($email, $applicationId);
$appNumber = 'UD/' . $user['number'] . '/' . sizeof($user['applications']);

$from = "Uprzejmie Donosze <ud@nieradka.net>";
$to = "<$email>";
$subject = "Zgłoszenie $appNumber";


$json = Array(
	"status" => "confirmed",
	"number" => $appNumber
);

$application = (array) array_merge((array)$application, (array)$json);
setApplication($applicationId, $application);

$emailTemplate = <<<HTML
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	</head>
	<body style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space; line-break: after-white-space;	">
		<p>
			<font color="#444444">Zgłoszenie:</font>&nbsp;<b>$appNumber</b>
		</p>

		<p>W dniu $app_date roku o godzinie $app_hour byłem świadkiem pozostawienia
		samochodu o nr rejestracyjnym $app_plateId pod adresem $app_address.
		$category
		Sytuacja jest widoczna na załączonych zdjęciach.</p>

		<p>Nie byłem świadkiem samego momentu parkowania oraz nie wiem jak długo
		pozostawał pojazd pozostawał na tym miejscu.</p>
		<p>$comment</p>

		<p>Dane adresowe oraz kontaktowe zgłaszającego:</p>
		<div>
			<div>
				<span class="Apple-tab-span" style="white-space:pre">	</span>$name<br>
				<span class="Apple-tab-span" style="white-space:pre">	</span>$msisdn<br>
				<span class="Apple-tab-span" style="white-space:pre">	</span><a href="mailto:$email">$email</a><br>
				<br><span style="color: rgb(68, 68, 68);" >Zdjęcia:</span><br><br>
				<a style="border: 1px solid #009C7F;" href="https://$host/$carImage"><img data-src="cid:carImage"></a>
				<a style="border: 1px solid #009C7F;" href="https://$host/$contextImage"><img data-src="cid:contextImage"></a><br>
			</div>
		</div>
	</body>
</html>
HTML;


$headers = array(
	'From' => $from,
	'To' => $to,
	'Bcc' => "<szymon@nieradka.net>",
	'Content-Type' => 'text/html; charset=UTF-8',
	'MIME-Version' => 1,
	'Subject' => $subject
);

$mimeParams = array(
	"text_encoding" => "7bit",
	"text_charset" => "UTF-8",
	"html_charset" => "UTF-8",
	"head_charset" => "UTF-8"
);
$mime =  new Mail_mime(array('eol' => "\n"));

$mime = new Mail_mime("\n");
$mime->setHTMLBody($emailTemplate);
$mime->setTXTBody(strip_tags($emailTemplate));
$mime->addHTMLImage($carImage, "image/jpeg", "", true, "carImage");
$mime->addHTMLImage($contextImage, "image/jpeg", "", true, "contextImage");

$body = $mime->getMessageBody($mimeParams);
$headers = $mime->headers($headers);

$smtp = Mail::factory('smtp', array(
	'host' => 'ssl://smtp.gmail.com',
	'port' => '465',
	'auth' => true,
	'username' => 'ud@nieradka.net',
	'password' => '95c112ef6964b209e633ed778da414bc'
));

$mail = $smtp->send($to, $headers, $body);

if (PEAR::isError($mail)) {
	echo('<p>' . $mail->getMessage() . '</p>');
} else {
	echo('<p>Dziękujemy za zgłoszenie!</p>');
}
?>
<body class="index">
	<div data-role="page" class="container-fluid" data-theme="a">
		<div data-role="header" data-position="fixed" data-tap-toggle="false">
			<a href="/" class="ui-btn-left  ui-alt-icon ui-nodisc-icon ui-btn ui-corner-all ui-icon-home ui-btn-icon-notext" data-role="button" role="button">Back</a>
			<h1>Dziękujemy</h1>
			<a href="nowe-zgloszenie.html" class="ui-btn-right ui-alt-icon ui-nodisc-icon ui-btn ui-corner-all ui-btn-inline ui-btn-icon-left ui-icon-carat-r">Jeszcze raz</a>
		</div>
		<div data-role="main" class="ui-content">
			<p>Twoje zgłoszenie zostało właśnie wysłane do Straży Miejskiej.
			Historię swoim zgłoszeń możesz zawsze zobaczyć w swojej skrzynce
			mailowej.</p>
			<p>Obecna wersja aplikacji nie umożliwia przeglądania historii
			zgłoszeń ani ich statusów.</p>
			<p>Jeśli chcesz poznań status swojego zgłoszenia skontaktuj się ze
			Strażą Miejską pod adresem <a href="mailto:sm@xxx.pl">sm@sm.pl</a> lub
			zadzwoń na nr <a href="tel:9119656">91 19656</a>.</p>
			<p>Jeśli masz pytania do nas, skontaktuj się pod adresem <a
				href="mailto:ud@uprzejmiedonosze.net">ud@uprzejmiedonosze.net</a>.</p>
		</div> <!-- main -->
<? getFooter() ?>
