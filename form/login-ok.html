<? 
date_default_timezone_set('Europe/Warsaw');
require_once(__DIR__ . '/../autoload.php');
require_once(__DIR__ . '/../inc/include.php');

$signInSuccessUrl = 'start.html';
if(isset($_GET['next'])){
    $signInSuccessUrl = $_GET['next'];
}
logger("login-ok.html: signInSuccessUrl == $signInSuccessUrl");

if(isset($_GET['pa']) && verifyToken($_GET['pa'])){
    redirect($signInSuccessUrl);
}else{
    genHeader(); ?>

<body class="index">
    <script src="https://www.gstatic.com/firebasejs/ui/2.5.1/firebase-ui-auth__pl.js"></script>
    <script type="text/javascript">
        initApp = function() {
            firebase.auth().onAuthStateChanged(function(user) {
            if (user) {
                user.getIdToken().then(function(accessToken) {
                    window.location.replace('/login-ok.html?pa=' + accessToken + '&next=' + '<?= $signInSuccessUrl ?>');
                });
            } else {
                window.location.replace('/login.html');
            }
            }, function(error) {
                console.log(error);
                window.location.replace('/login.html');
            });
        };

        window.addEventListener('load', function() {
            initApp()
        });
    </script>
    
<? getFooter(); } ?>
