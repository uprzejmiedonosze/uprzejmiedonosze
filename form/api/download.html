<?PHP
date_default_timezone_set('Europe/Warsaw');
require(__DIR__ . '/../../inc/include.php');

$ROOT = __DIR__ . "/..";

if(!isset($_GET['appId'])){
    http_response_code(400);
    die();
}

$applicationId = $_GET['appId'];
$application = getApplication($applicationId);

if(!isset($application)){
    http_response_code(404);
    die();
}

$pdf = "$ROOT/cdn/$applicationId.pdf";
$filename = 'Zgloszenie_' . str_replace('/', '-', $application->number) . '.pdf';

if(!file_exists($pdf)){
    generate_pdf($application, $pdf);
}

header('Content-Type: application/pdf');
header("Content-Transfer-Encoding: Binary");
header("Content-disposition: attachment; filename=$filename");
readfile($pdf);

function generate_pdf($application, $outp_file) {
	global $ROOT;

	$template_file = __DIR__ . '/template.tex.twig';

	if(!file_exists($template_file)) {
		throw new Exception("Could not open template");
	}
	if(($f = tempnam(sys_get_temp_dir(), 'tex-')) === false) {
		throw new Exception("Failed to create temporary file");
	}

	$tex_f = "$f.tex";
	$aux_f = "$f.aux";
	$out_f = "$f.out";
	$log_f = "$f.log";
	$pdf_f = "$f.pdf";

	$loader = new Twig_Loader_Filesystem(__DIR__ . '/');
	$twig = new Twig_Environment($loader);

	ob_start();
	echo $twig->render('template.tex.twig', flatten_application($application));
	file_put_contents($tex_f, ob_get_clean());

	$cmd = sprintf("/usr/bin/pdflatex -interaction nonstopmode %s", // -halt-on-error
   escapeshellarg($tex_f));
	chdir(sys_get_temp_dir());
	exec($cmd, $output, $ret);

   @unlink($tex_f);
	@unlink($aux_f);
	@unlink($log_f);
	@unlink($out_f);

	if(!file_exists($pdf_f)) {
		@unlink($f);
		throw new Exception("Output was not generated and latex returned: $ret.");
	}
    
	$destFile = "$ROOT/cdn/{$application->id}.pdf";
	rename($pdf_f, $destFile);
	@unlink($f);
}

function guess_sm_address($application){
	global $sm_addresses;

	$sm = '(skontaktuj się z autorem \\\\ aby podać adres SM dla twojego miasta)';
	$city = trim(strtolower($application->address->city));

	if(array_key_exists($city, $sm_addresses)){
		$sm = $sm_addresses[strtolower($application->address->city)];
	}else{
		$address = trim(strtolower($application->address->address));
		foreach($sm_addresses as $c => $a){
			if (strpos($address, $c) !== false){
				$sm = $a;
				break;
			}
		}
	}
	return $sm;
}

function guess_sex($application){
	$names = preg_split('/\s+/', strtolower($application->user->name));
	if(count($names) < 1){
		return "byłam/em";
	}
	if($names[0] == 'kuba' || substr($names[0], -1) != 'a'){
		return "byłem";
	}
	return "byłam";
}

function flatten_application($application){
	global $ROOT, $categories_txt, $sm_addresses;

	$includegraphics = '\\includegraphics[width=0.5\\textwidth,height=0.5\\textwidth,clip=true,keepaspectratio=true]{';
	$contextImage = $includegraphics . $ROOT . "/" . $application->contextImage->url . "}";
	$carImage = $includegraphics . $ROOT . "/" . $application->carImage->url . "}";

	$plateImage = "";
	@$plateImage = "\\includegraphics[width=0.2\\textwidth,height=0.2\\textwidth,clip=true,keepaspectratio=true]{" . $ROOT . "/" . $application->carInfo->plateImage . "}";

	$sm = guess_sm_address($application);
	$sex = guess_sex($application);

	$data = Array(
		'app' => Array(
			'contextImage' => $contextImage,
			'carImage' => $carImage,
			'plateImage' => $plateImage,
			'name_name' => $application->user->name,
			'sex' => $sex,
			'date' => date_format(new DateTime($application->date), 'Y-m-d'),
			'hour' => date_format(new DateTime($application->date), 'H:i'),
			'plateId' => $application->carInfo->plateId,
			'user_address' => $application->user->address,
			'category' => $categories_txt[$application->category],
			'address' => $application->address->address,
			'user_phone' => "Tel: {$application->user->msisdn}",
    		'user_email' => "Email: {$application->user->email}",
			'number' => $application->number,
			'city' => $application->address->city,
			'sm' => $sm
		)
	);

	return $data;
}

?>
